name: CI/CD Pipeline

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  ÐšÐ¾Ð³Ð´Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ:
#
#  push â†’ main        CI Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ + Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
#  pull_request        Ð¢ÐžÐ›Ð¬ÐšÐž CI Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ (lint, build) â€” Ð‘Ð•Ð— Ð´ÐµÐ¿Ð»Ð¾Ñ.
#                       Ð Ð°Ð·Ñ€Ð°Ð± Ð²Ð¸Ð´Ð¸Ñ‚ âœ…/âŒ Ð¿Ñ€ÑÐ¼Ð¾ Ð² PR Ð´Ð¾ Ð¼ÐµÑ€Ð¶Ð°.
#  workflow_dispatch    Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð¸Ð· GitHub UI (Ñ Ð¾Ð¿Ñ†Ð¸ÐµÐ¹ force_deploy)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: "ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¿ÐµÑ€ÐµÑÐ±Ð¾Ñ€ÐºÐ° Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²"
        type: boolean
        default: false

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  ÐžÐ§Ð•Ð Ð•Ð”Ð¬, ÐÐ• ÐžÐ¢ÐœÐ•ÐÐ
#
#  cancel-in-progress: false â€” ÐµÑÐ»Ð¸ Dev A Ð´ÐµÐ¿Ð»Ð¾Ð¸Ñ‚, Ð° Dev B
#  Ð¿ÑƒÑˆÐ¸Ñ‚, Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½ B Ð²ÑÑ‚Ð°Ñ‘Ñ‚ Ð’ ÐžÐ§Ð•Ð Ð•Ð”Ð¬ Ð¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ A.
#  GitHub Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ Ð¼Ð°ÐºÑ. 1 pending run â€” ÐµÑÐ»Ð¸ C Ð¿ÑƒÑˆÐ¸Ñ‚ Ð¿Ð¾ÐºÐ° B
#  Ð¶Ð´Ñ‘Ñ‚, B Ð¾Ñ‚Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ (Ð¾Ð½ ÐµÑ‰Ñ‘ Ð½Ðµ Ð½Ð°Ñ‡Ð¸Ð½Ð°Ð»ÑÑ), C Ð¶Ð´Ñ‘Ñ‚.
#
#  Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: A Ð´Ð¾Ñ…Ð¾Ð´Ð¸Ñ‚ Ð´Ð¾ ÐºÐ¾Ð½Ñ†Ð° (Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ðµ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°ÐµÑ‚ÑÑ!),
#  Ð·Ð°Ñ‚ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¸Ñ‚ÑÑ C (ÑƒÐ¶Ðµ Ñ ÐºÐ¾Ð´Ð¾Ð¼ A+B+C).
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
concurrency:
  group: cicd-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write

env:
  DEPLOY_PATH: /opt/hackathon

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1. DETECT â€” ÐºÐ°ÐºÐ¸Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¸ÑÑŒ
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  detect-changes:
    name: "ðŸ” Detect Changes"
    runs-on: ubuntu-latest
    outputs:
      frontend:      ${{ steps.changes.outputs.frontend }}
      auth-service:  ${{ steps.changes.outputs.auth-service }}
      java-backend:  ${{ steps.changes.outputs.java-backend }}
      go-backend:    ${{ steps.changes.outputs.go-backend }}
      ml-service:    ${{ steps.changes.outputs.ml-service }}
      caddy:         ${{ steps.changes.outputs.caddy }}
      infra:         ${{ steps.changes.outputs.infra }}
      any-service:   ${{ steps.any.outputs.any-service }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            frontend:
              - 'services/vite-project/**'
            auth-service:
              - 'services/auth-service/**'
            java-backend:
              - 'services/ai-agent-service/**'
            go-backend:
              - 'services/go-backend/**'
            ml-service:
              - 'services/ml-service/**'
            caddy:
              - 'services/caddy/**'
            infra:
              - 'docker-compose.yml'
              - 'scripts/**'
              - '.env_example'

      - name: Determine if any service changed
        id: any
        run: |
          if [[ "${{ steps.changes.outputs.frontend }}" == "true" || \
                "${{ steps.changes.outputs.auth-service }}" == "true" || \
                "${{ steps.changes.outputs.java-backend }}" == "true" || \
                "${{ steps.changes.outputs.go-backend }}" == "true" || \
                "${{ steps.changes.outputs.ml-service }}" == "true" || \
                "${{ steps.changes.outputs.caddy }}" == "true" || \
                "${{ steps.changes.outputs.infra }}" == "true" || \
                "${{ github.event.inputs.force_deploy }}" == "true" ]]; then
            echo "any-service=true" >> "$GITHUB_OUTPUT"
          else
            echo "any-service=false" >> "$GITHUB_OUTPUT"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2. LINT & BUILD â€” Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
  #    Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¸ Ð½Ð° push, Ð¸ Ð½Ð° PR.
  #    ÐÐ° PR Ñ€Ð°Ð·Ñ€Ð°Ð± Ð²Ð¸Ð´Ð¸Ñ‚ Ð³Ð°Ð»Ð¾Ñ‡ÐºÐ¸ âœ…/âŒ Ð´Ð¾ Ð¼ÐµÑ€Ð¶Ð°.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # â”€â”€ Frontend â”€â”€
  lint-frontend:
    name: "ðŸ–¥ï¸ Frontend â€” Lint & Build"
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: services/vite-project
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: services/vite-project/package-lock.json

      - run: npm ci --prefer-offline
      - run: npx tsc -b --noEmit
        name: TypeScript Check
      - run: npm run lint
        name: ESLint
      - run: npm run build
        name: Vite Build

  # â”€â”€ Go Backend â”€â”€
  lint-go:
    name: "ðŸ¹ Go Backend â€” Lint & Build"
    needs: detect-changes
    if: needs.detect-changes.outputs.go-backend == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: services/go-backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: services/go-backend/go.mod
          cache-dependency-path: services/go-backend/go.sum

      - run: go vet ./...
        name: Go Vet
      - run: go build -o /dev/null ./cmd/...
        name: Go Build

  # â”€â”€ Auth Service (Java) â”€â”€
  lint-auth:
    name: "ðŸ” Auth Service â€” Build"
    needs: detect-changes
    if: needs.detect-changes.outputs.auth-service == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: services/auth-service
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - run: ./mvnw compile -B -q -DskipTests -Dprop.skipLoadProperties=true
        name: Maven Compile

  # â”€â”€ AI Agent Service (Java) â”€â”€
  lint-java-backend:
    name: "ðŸ¤– AI Agent â€” Build"
    needs: detect-changes
    if: needs.detect-changes.outputs.java-backend == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: services/ai-agent-service
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - run: ./mvnw compile -B -q -DskipTests -Dprop.skipLoadProperties=true
        name: Maven Compile

  # â”€â”€ ML Service (Python) â”€â”€
  lint-ml:
    name: "ðŸ§  ML Service â€” Lint"
    needs: detect-changes
    if: needs.detect-changes.outputs.ml-service == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    defaults:
      run:
        working-directory: services/ml-service
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - run: pip install -q ruff
      - run: ruff check .
        name: Ruff Lint
        continue-on-error: true

  # â”€â”€ Caddy config â”€â”€
  validate-caddy:
    name: "ðŸŒ Caddy â€” Validate Config"
    needs: detect-changes
    if: needs.detect-changes.outputs.caddy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Build custom Caddy (with rate_limit plugin)
        run: |
          docker build -t caddy-custom -f services/caddy/Dockerfile services/caddy/

      - name: Validate Caddyfile syntax
        run: |
          docker run --rm \
            -v "${{ github.workspace }}/services/caddy/Caddyfile:/etc/caddy/Caddyfile:ro" \
            caddy-custom \
            caddy validate --config /etc/caddy/Caddyfile --adapter caddyfile

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 3. DEPLOY â€” Ñ‚Ð¾Ð»ÑŒÐºÐ¾ push Ð² main + Ð²ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÐžÐš
  #
  #    ÐÐ• Ð´ÐµÐ¿Ð»Ð¾Ð¸Ñ‚ ÐºÐ¾Ð³Ð´Ð°:
  #    â€¢ pull_request â€” PR Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ÑÑ, Ð½Ðµ Ð´ÐµÐ¿Ð»Ð¾Ð¸Ñ‚ÑÑ
  #    â€¢ push ÐÐ• Ð² main â€” Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð²ÐµÑ‚ÐºÐ¸ Ð½Ðµ Ð´ÐµÐ¿Ð»Ð¾ÑÑ‚ÑÑ
  #    â€¢ Ð½Ð¸ Ð¾Ð´Ð¸Ð½ ÑÐµÑ€Ð²Ð¸Ñ Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»ÑÑ
  #    â€¢ Ñ…Ð¾Ñ‚Ñ Ð±Ñ‹ Ð¾Ð´Ð½Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÐ¿Ð°Ð»Ð° (failure)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: "ðŸš€ Deploy to Production"
    needs:
      - detect-changes
      - lint-frontend
      - lint-go
      - lint-auth
      - lint-java-backend
      - lint-ml
      - validate-caddy
    if: |
      always() &&
      github.event_name != 'pull_request' &&
      github.ref == 'refs/heads/main' &&
      (needs.detect-changes.outputs.any-service == 'true' || github.event.inputs.force_deploy == 'true') &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: production
      url: https://besthackaton.duckdns.org
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: hackathon
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          script_stop: true
          command_timeout: 15m
          script: |
            set -euo pipefail
            cd /opt/hackathon

            echo "â”€â”€ Git pull â”€â”€"
            git fetch origin main
            git reset --hard origin/main

            echo "â”€â”€ Deploy â”€â”€"
            FORCE_DEPLOY=${{ github.event.inputs.force_deploy == 'true' && '1' || '0' }}
            export FORCE_DEPLOY
            bash scripts/deploy.sh

      - name: Verify deployment health
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: hackathon
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          script_stop: true
          command_timeout: 3m
          script: |
            set -euo pipefail

            echo "â”€â”€ Health Check â”€â”€"
            sleep 10

            FAILED=0
            for svc in hackathon-caddy hackathon-auth hackathon-java hackathon-go hackathon-frontend hackathon-ml; do
              STATUS=$(docker inspect --format='{{.State.Health.Status}}' "$svc" 2>/dev/null || echo "not_found")
              if [[ "$STATUS" == "healthy" ]]; then
                echo "âœ… $svc: $STATUS"
              elif [[ "$STATUS" == "starting" ]]; then
                echo "â³ $svc: $STATUS (still starting)"
              else
                echo "âŒ $svc: $STATUS"
                FAILED=1
              fi
            done

            if [[ "$FAILED" -eq 1 ]]; then
              echo ""
              echo "âš ï¸ Some services are unhealthy. Last logs:"
              docker compose --profile all logs --tail=15 2>&1 | tail -40
              exit 1
            fi

            echo ""
            echo "ðŸŽ‰ All services healthy!"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 4. NOTIFY â€” ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ (Telegram)
  #    Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ TELEGRAM_BOT_TOKEN Ð¸
  #    TELEGRAM_CHAT_ID Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify:
    name: "ðŸ“¢ Notify Team"
    needs: [detect-changes, deploy]
    if: always() && needs.deploy.result != 'skipped'
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram notification
        continue-on-error: true
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [[ -z "$TELEGRAM_TOKEN" || -z "$TELEGRAM_CHAT" ]]; then
            echo "â„¹ï¸ Telegram Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ â€” Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼"
            exit 0
          fi

          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            ICON="âœ…"
            STATUS="Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑƒÑÐ¿ÐµÑˆÐµÐ½"
          else
            ICON="âŒ"
            STATUS="Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑƒÐ¿Ð°Ð»"
          fi

          MSG="${ICON} *${STATUS}*
          ðŸ“¦ ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: \`${{ github.sha }}\`
          ðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: ${{ github.actor }}
          ðŸ“ ${{ github.event.head_commit.message || 'manual dispatch' }}
          ðŸ”— [ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT" \
            -d parse_mode="Markdown" \
            -d text="$MSG" \
            -d disable_web_page_preview=true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 5. SUMMARY â€” ÐºÑ€Ð°ÑÐ¸Ð²Ð°Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ð² GitHub UI
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: "ðŸ“‹ Pipeline Summary"
    needs:
      - detect-changes
      - lint-frontend
      - lint-go
      - lint-auth
      - lint-java-backend
      - lint-ml
      - validate-caddy
      - deploy
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ—ï¸ CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Changed | Check | Deploy |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|-------|--------|" >> $GITHUB_STEP_SUMMARY

          declare -A SVC_NAMES=(
            [frontend]="ðŸ–¥ï¸ Frontend"
            [auth-service]="ðŸ” Auth"
            [java-backend]="ðŸ¤– AI Agent"
            [go-backend]="ðŸ¹ Go Backend"
            [ml-service]="ðŸ§  ML Service"
            [caddy]="ðŸŒ Caddy"
          )

          declare -A CHECK_JOBS=(
            [frontend]="${{ needs.lint-frontend.result }}"
            [auth-service]="${{ needs.lint-auth.result }}"
            [java-backend]="${{ needs.lint-java-backend.result }}"
            [go-backend]="${{ needs.lint-go.result }}"
            [ml-service]="${{ needs.lint-ml.result }}"
            [caddy]="${{ needs.validate-caddy.result }}"
          )

          deploy_status="${{ needs.deploy.result }}"
          [[ "$deploy_status" == "success" ]] && deploy_icon="âœ…" || deploy_icon="â€”"

          for svc in frontend auth-service java-backend go-backend ml-service caddy; do
            changed="â€”"
            check="â€”"

            case "$svc" in
              frontend)      [[ "${{ needs.detect-changes.outputs.frontend }}" == "true" ]] && changed="âœ…" ;;
              auth-service)  [[ "${{ needs.detect-changes.outputs.auth-service }}" == "true" ]] && changed="âœ…" ;;
              java-backend)  [[ "${{ needs.detect-changes.outputs.java-backend }}" == "true" ]] && changed="âœ…" ;;
              go-backend)    [[ "${{ needs.detect-changes.outputs.go-backend }}" == "true" ]] && changed="âœ…" ;;
              ml-service)    [[ "${{ needs.detect-changes.outputs.ml-service }}" == "true" ]] && changed="âœ…" ;;
              caddy)         [[ "${{ needs.detect-changes.outputs.caddy }}" == "true" ]] && changed="âœ…" ;;
            esac

            result="${CHECK_JOBS[$svc]}"
            if [[ "$result" == "success" ]]; then check="âœ…"
            elif [[ "$result" == "failure" ]]; then check="âŒ"
            elif [[ "$result" == "skipped" ]]; then check="â­ï¸"
            fi

            echo "| ${SVC_NAMES[$svc]} | $changed | $check | $deploy_icon |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy:** \`$deploy_status\` | **Trigger:** \`${{ github.event_name }}\` | **Ref:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
