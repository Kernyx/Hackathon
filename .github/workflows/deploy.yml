name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: "ðŸš€ Deploy"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: hackathon
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          script_stop: true
          command_timeout: 5m
          script: |
            set -euo pipefail
            cd /opt/hackathon

            echo "â”€â”€ Git pull â”€â”€"
            git fetch origin main
            git reset --hard origin/main

            echo "â”€â”€ Deploy â”€â”€"
            bash scripts/deploy.sh

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: hackathon
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          script_stop: true
          command_timeout: 3m
          script: |
            set -euo pipefail
            sleep 10

            FAILED=0
            for svc in hackathon-caddy hackathon-auth hackathon-java hackathon-go hackathon-frontend; do
              STATUS=$(docker inspect --format='{{.State.Health.Status}}' "$svc" 2>/dev/null || echo "not_found")
              if [[ "$STATUS" == "healthy" ]]; then
                echo "âœ… $svc: $STATUS"
              elif [[ "$STATUS" == "starting" ]]; then
                echo "â³ $svc: $STATUS"
              else
                echo "âŒ $svc: $STATUS"
                FAILED=1
              fi
            done

            ML_STATE=$(docker inspect --format='{{.State.Status}}' hackathon-ml 2>/dev/null || echo "not_found")
            echo "â„¹ï¸ hackathon-ml: $ML_STATE"

            if [[ "$FAILED" -eq 1 ]]; then
              docker compose --profile all logs --tail=15 2>&1 | tail -40
              exit 1
            fi

            echo "ðŸŽ‰ All services healthy!"
