# Туннель LM Studio → VPS для ML-сервиса

ML-сервис в Docker обращается к LLM по адресу `http://host.docker.internal:1234/v1`.  
LM Studio запускается на машине ml-шика (Windows). Чтобы VPS мог слать запросы в LM Studio, нужен **reverse SSH-туннель**.

## 1. SSH-туннель (на стороне ml-шика)

```bash
ssh -N -R 0.0.0.0:1234:192.168.88.56:1234 hackathon@46.17.46.192
```

На VPS порт 1234 должен слушаться на **всех интерфейсах** (`0.0.0.0`), иначе контейнер (он стучится на IP хоста 172.17.0.1) до туннеля не достучится.

## 2. Фаервол на VPS (обязательно, если контейнер не видит 1234)

Контейнер `ml-service` в **пользовательской** сети `hackathon-net`, не в default bridge. Шлюз у него свой — чаще всего **172.18.0.1** (а не 172.17.0.1). С хоста `curl 172.17.0.1:1234` может работать, но контейнер стучится на **свой** шлюз (172.18.0.1 и т.п.). Нужно разрешить порт 1234 с **подсети этого шлюза**.

**Узнать IP, на который контейнер ходит:**

```bash
docker exec hackathon-ml getent hosts host.docker.internal
# пример вывода: 172.18.0.1  host.docker.internal
```

**Проверка с хоста** (подставьте свой шлюз, например 172.18.0.1):

```bash
curl -s -m 3 http://172.18.0.1:1234/v1/models | head -c 200
```

Если здесь таймаут — туннель не слушает на этом интерфейсе (перезапустите ssh с `-R 0.0.0.0:1234:...`).  
Если здесь OK, а из контейнера таймаут — режет фаервол: нужна разрешающая правило для **подсети шлюза** (172.18.0.0/16, не только 172.17.0.0/16).

**Разрешить порт 1234 с подсети hackathon-net (подставьте свой шлюз):**

```bash
# для шлюза 172.18.0.1 — подсеть 172.18.0.0/16
sudo iptables -I INPUT -p tcp -s 172.18.0.0/16 --dport 1234 -j ACCEPT

# если уже добавляли только 172.17.0.0/16 — добавьте и 172.18.0.0/16
sudo iptables -I INPUT -p tcp -s 172.17.0.0/16 --dport 1234 -j ACCEPT
sudo iptables -I INPUT -p tcp -s 172.18.0.0/16 --dport 1234 -j ACCEPT

# сохранить (Debian/Ubuntu)
sudo netfilter-persistent save
```

Скрипт диагностики подскажет точную команду:

```bash
bash /opt/hackathon/scripts/fix-ml-ollama-connectivity.sh
```

Если используется **firewalld** — добавьте в trusted (или в нужную зону) источник 172.18.0.0/16 и порт 1234.

## 3. Проверка

На VPS после поднятия туннеля и правила фаервола:

```bash
# с хоста
curl -s http://172.17.0.1:1234/v1/models | head -c 200

# из контейнера
docker exec hackathon-ml python -c "
import urllib.request
r = urllib.request.urlopen('http://host.docker.internal:1234/v1/models', timeout=5)
print('OK:', r.read().decode()[:150])
"
```

Обе команды должны вернуть ответ от LM Studio.
