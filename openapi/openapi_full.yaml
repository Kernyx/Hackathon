openapi: 3.1.0
info:
  title: API
  version: 1.0.0
servers:
  - url: /api/v1
paths:
  /auth/signup:
    post:
      tags:
        - Authentication Service
      summary: Sign up
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignUpDto'
      responses:
        '201':
          description: User successfully registered
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'
  /auth/signin:
    post:
      tags:
        - Authentication Service
      summary: Sign in
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignInDto'
      responses:
        '200':
          description: User authenticated
        '400':
          $ref: '#/components/responses/BadRequest'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'
  /auth/refresh-token:
    get:
      tags:
        - Authentication Service
      summary: Refresh access token
      parameters:
        - name: refreshToken
          in: cookie
          required: true
          description: Refresh token required to update access token
          schema:
            type: string
            format: jwt
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: Access token updated
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'
  /ai-agent/agents:
    post:
      tags:
        - AI Agent Service
      summary: Create AI agent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AiAgentDto'
      responses:
        '201':
          description: AI Agent created
        '400':
          description: Bad credentials
        '401':
          description: Unauthorized
  /ai-agent/agents/{agentId}:
    get:
      tags:
        - AI Agent Service
      summary: Get AI agent
      parameters:
        - name: agentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Returns AI agent
        '400':
          description: Bad credentials
        '401':
          description: Unauthorized
    delete:
      tags:
        - AI Agent Service
      summary: Delete AI agent
      parameters:
        - name: agentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: AI Agent deleted
        '400':
          description: Bad credentials
        '401':
          description: Unauthorized
    put:
      tags:
        - AI Agent Service
      summary: Update AI agent
      parameters:
        - name: agentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the agent to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AiAgentDto'
      responses:
        '200':
          description: AI Agent updated successfully
        '400':
          description: Bad credentials
        '401':
          description: Unauthorized
  /ai-agent/users/{userId}/agents/relations:
    get:
      tags:
        - AI Agent Service
      summary: Get relations for user
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID of the user
      responses:
        '200':
          description: List of agent relations
        '400':
          description: Bad credentials
        '401':
          description: Unauthorized
  /audit/events:
    post:
      tags:
        - Audit Service
      summary: Отправить событие в аудит
      description: |
        Отправляет полное событие симуляции в систему аудита.
        На каждом тике ML-сервис отправляет действия агентов.
        JWT токен в заголовке Authorization содержит userId.
      operationId: publishEvent
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuditEvent'
            example:
              event_type: "message_sent"
              source_agent:
                agent_id: "agent_1"
                name: "Алиса"
                mood:
                  dominant_emotion: "спокойствие"
                  happiness: 0.3
                  energy: 0.7
                  stress: 0.1
                  anger: 0.0
                  fear: 0.0
                relationships:
                  agent_2:
                    value: 0.15
                    display_name: "Борис"
                  agent_3:
                    value: -0.10
                    display_name: "Вика"
                activity:
                  talkativeness: 0.65
                  messages_spoken: 12
                plan:
                  goal: "Построить укрытие"
                  current_step: 2
              target_agents:
                - agent_id: "agent_2"
                  name: "Борис"
                - agent_id: "agent_3"
                  name: "Вика"
              timestamp: "2026-02-17T22:25:26.485Z"
              data:
                message: "Давайте построим укрытие из пальм!"
                tick: 5
                is_initiative: true
                action_result: null
                sentiments:
                  agent_2:
                    delta: 0.05
                    reason: "позитив: 'согласен'"
              simulation_context:
                scenario_name: "Необитаемый остров"
                current_topic: "как построить укрытие из пальм?"
                phase: "decide"
      responses:
        '202':
          description: Событие принято
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditEventAccepted'
        '400':
          description: Невалидный запрос
        '401':
          description: Не авторизован
        '429':
          description: Слишком много запросов

  # ── ML AI Service ──────────────────────────────────────────

  /ml/users/{userId}/session:
    post:
      tags:
        - ML AI Service
      summary: Создать сессию
      description: Создаёт агентов, выбирает сценарий, запускает фоновую симуляцию.
      operationId: createSession
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionCreateRequest'
      responses:
        '200':
          description: Сессия создана
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionInfo'
        '400':
          description: Неизвестный сценарий или расовый пресет
        '500':
          description: Внутренняя ошибка
    get:
      tags:
        - ML AI Service
      summary: Получить информацию о сессии
      operationId: getSession
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Информация о сессии
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionInfo'
        '404':
          description: Сессия не найдена

  /ml/users/{userId}/session/settings:
    patch:
      tags:
        - ML AI Service
      summary: Изменить настройки сессии
      description: |
        Обновляет скорость общения агентов — задержку в секундах между сообщениями.
        Фронтенд отправляет поле speed_seconds (от 0.5 до 60 секунд).
      operationId: updateSessionSettings
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionSettingsRequest'
            examples:
              fast:
                summary: Быстрая скорость
                value:
                  speed_seconds: 1.0
              normal:
                summary: Нормальная скорость
                value:
                  speed_seconds: 5.0
              slow:
                summary: Медленная скорость
                value:
                  speed_seconds: 15.0
      responses:
        '200':
          description: Настройки обновлены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionSettingsResponse'
        '400':
          description: Невалидные параметры
        '404':
          description: Сессия не найдена

  /ml/users/{userId}/messages:
    post:
      tags:
        - ML AI Service
      summary: Отправить сообщение агентам
      description: |
        Отправляет сообщение от пользователя. Агенты генерируют ответы.
        target_agent — для личного сообщения одному агенту (опционально).
      operationId: sendMessage
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MlMessageRequest'
      responses:
        '200':
          description: Ответы агентов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MlMessageResponse'
        '404':
          description: Сессия или агент не найден
        '500':
          description: Ошибка генерации ответа

  /ml/users/{userId}/conversation:
    get:
      tags:
        - ML AI Service
      summary: Получить историю сообщений (polling)
      description: |
        Возвращает историю сообщений для polling.
        after_tick=-1 → все; after_tick=N → только новые после тика N.
      operationId: getConversation
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
        - name: after_tick
          in: query
          required: false
          schema:
            type: integer
            default: -1
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 200
      responses:
        '200':
          description: История сообщений
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MlConversationResponse'
        '404':
          description: Сессия не найдена
components:
  schemas:
    ErrorCode:
      type: string
      description: |
        Application specific error codes.
        Prefixes: A - Authentication, S - Signup, L - Login, AT - Access Token, RT - Refresh Token, R - Authorization
      enum:
        - A-1000
        - A-S1001
        - A-L1001
        - A-L1002
        - A-L1003
        - A-AT1001
        - A-AT1002
        - A-RT1001
        - A-RT1002
        - A-R1001
        - A-R1002
        - A-R1003
      x-enum-varnames:
        - INTERNAL_ERROR
        - INVALID_SIGNUP_CREDENTIALS
        - INVALID_LOGIN_CREDENTIALS
        - ACCOUNT_BANNED
        - TOO_MANY_LOGIN_ATTEMPTS
        - ACCESS_TOKEN_EXPIRED
        - ACCESS_TOKEN_INVALID
        - REFRESH_TOKEN_EXPIRED
        - REFRESH_TOKEN_INVALID
        - INSUFFICIENT_PERMISSIONS
        - FORBIDDEN_RESOURCE
        - ROLE_NOT_ALLOWED
      x-enum-descriptions:
        - Internal error
        - Invalid signup credentials
        - Invalid login credentials
        - Account banned
        - Too many login attempts
        - Access token expired
        - Access token signature invalid
        - Refresh token expired
        - Refresh token invalid
        - Insufficient permissions
        - Forbidden resource
        - Role not allowed
    ErrorResponse:
      type: object
      required:
        - code
        - message
        - timestamp
      properties:
        code:
          $ref: '#/components/schemas/ErrorCode'
        message:
          type: string
          description: Human readable error message
          example: Access token expired
        timestamp:
          type: string
          format: date-time
          description: Error occurrence time
        traceId:
          type: string
          description: Unique identifier for log tracing
          example: 6f8c2d1e
    SignUpDto:
      type: object
      required:
        - username
        - email
        - password
      properties:
        username:
          type: string
          examples:
            - winner1337
        email:
          type: string
          examples:
            - admin@admin.com
        password:
          type: string
          examples:
            - admin
    SignInDto:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          examples:
            - admin@admin.com
        password:
          type: string
          examples:
            - admin
    AiAgentDto:
      type: object
      properties:
        userId:
          type: string
          format: uuid
        username:
          type: string
          example: Alex
        photoLink:
          type: string
          format: byte
        isMale:
          type: boolean
        age:
          type: integer
          example: 22
        interests:
          type: string
          example: Ездить по ночам на питбайке
        personalityType:
          $ref: '#/components/schemas/PersonalityType'
        traits:
          $ref: '#/components/schemas/AgentTraits'
        additionalInformation:
          type: string
          example: Любит яблоки
    AgentTraits:
      type: object
      description: Черты характера
      properties:
        openness:
          type: integer
        conscientiousness:
          type: integer
        extraversion:
          type: integer
        agreeableness:
          type: integer
        neuroticism:
          type: integer
    PersonalityType:
      type: string
      description: Тип личности агента
      enum:
        - ALTRUIST
        - MACHIAVELLIAN
        - REBEL
        - STOIC
        - INDIVIDUAL
      x-enum-varnames:
        - ALTRUIST
        - MACHIAVELLIAN
        - REBEL
        - STOIC
        - INDIVIDUAL
    AiAgent:
      type: object
      required:
        - id
        - username
      properties:
        id:
          type: string
          format: uuid
          description: Уникальный идентификатор агента
        username:
          type: string
          description: Имя агента
          examples:
            - ИИ агент Габена

    # ── ML AI Service schemas ──

    SessionCreateRequest:
      type: object
      properties:
        scenario:
          type: string
          description: Ключ сценария
          default: desert_island
          enum:
            - desert_island
            - space_station
            - zombie_apocalypse
            - medieval_tavern
        race_preset:
          type: string
          description: Ключ расового пресета
          default: humans
          enum:
            - humans
            - fantasy_party
            - mixed_survival
            - classic_party

    SessionSettingsRequest:
      type: object
      required:
        - speed_seconds
      properties:
        speed_seconds:
          type: number
          format: float
          description: |
            Задержка между сообщениями агентов в секундах.
            Минимум 0.5, максимум 60.
          minimum: 0.5
          maximum: 60.0
          default: 5.0
          examples:
            - 1.0
            - 5.0
            - 15.0

    SessionSettingsResponse:
      type: object
      properties:
        user_id:
          type: string
        speed_seconds:
          type: number
          format: float
          description: Установленная задержка (сек)
        message:
          type: string
          examples:
            - "Скорость обновлена: 5.0 сек между сообщениями"

    SessionInfo:
      type: object
      properties:
        user_id:
          type: string
        is_active:
          type: boolean
        scenario:
          type: string
          examples:
            - Необитаемый остров
        agents:
          type: array
          items:
            $ref: '#/components/schemas/MlAgentInfo'
        tick:
          type: integer
        available_scenarios:
          type: array
          items:
            type: string
        available_race_presets:
          type: array
          items:
            type: string

    MlAgentInfo:
      type: object
      properties:
        agent_id:
          type: string
        name:
          type: string
          examples:
            - Алиса
        race:
          type: string
          examples:
            - human
        race_emoji:
          type: string
          examples:
            - "[Чел]"
        race_name:
          type: string
          examples:
            - Человек
        personality:
          type: string
          examples:
            - "Альтруист (добрый)"
        mood:
          type: string
          examples:
            - решимость
        is_male:
          type: boolean
        age:
          type: integer

    MlMessageRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          minLength: 1
          maxLength: 2000
        target_agent:
          type: string
          nullable: true
          description: Имя агента для личного сообщения. null = всем.

    MlMessageResponse:
      type: object
      properties:
        user_message:
          type: string
        target:
          type: string
          description: '"all" или имя агента'
        responses:
          type: array
          items:
            $ref: '#/components/schemas/MlAgentResponse'
        tick:
          type: integer
        session_id:
          type: string

    MlAgentResponse:
      type: object
      properties:
        agent_id:
          type: string
        name:
          type: string
        text:
          type: string
        tick:
          type: integer
        race:
          type: string
        race_emoji:
          type: string
        mood:
          type: string

    MlConversationResponse:
      type: object
      properties:
        user_id:
          type: string
        entries:
          type: array
          items:
            $ref: '#/components/schemas/MlConversationEntry'
        total:
          type: integer
        last_tick:
          type: integer
          description: Последний тик (передать как after_tick в следующем запросе)
        simulation_running:
          type: boolean

    MlConversationEntry:
      type: object
      properties:
        tick:
          type: integer
        agent_id:
          type: string
        name:
          type: string
        text:
          type: string
        is_event:
          type: boolean
          default: false
        is_new_topic:
          type: boolean
          default: false

    MlHealthResponse:
      type: object
      properties:
        status:
          type: string
        model:
          type: string
        llm_url:
          type: string

    # ── Audit Service schemas ──

    AuditMood:
      type: object
      properties:
        dominant_emotion:
          type: string
          examples:
            - "спокойствие"
        happiness:
          type: number
          format: float
          minimum: -1
          maximum: 1
        energy:
          type: number
          format: float
          minimum: -1
          maximum: 1
        stress:
          type: number
          format: float
          minimum: -1
          maximum: 1
        anger:
          type: number
          format: float
          minimum: -1
          maximum: 1
        fear:
          type: number
          format: float
          minimum: -1
          maximum: 1

    AuditRelationship:
      type: object
      properties:
        value:
          type: number
          format: float
          minimum: -1
          maximum: 1
        display_name:
          type: string

    AuditActivity:
      type: object
      properties:
        talkativeness:
          type: number
          format: float
          minimum: 0
          maximum: 1
        messages_spoken:
          type: integer
          minimum: 0

    AuditPlan:
      type: object
      properties:
        goal:
          type: string
        current_step:
          type: integer
          minimum: 0

    AuditSourceAgent:
      type: object
      required:
        - agent_id
        - name
      properties:
        agent_id:
          type: string
          examples:
            - "agent_1"
        name:
          type: string
          examples:
            - "Алиса"
        mood:
          $ref: '#/components/schemas/AuditMood'
        relationships:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/AuditRelationship'
        activity:
          $ref: '#/components/schemas/AuditActivity'
        plan:
          $ref: '#/components/schemas/AuditPlan'

    AuditTargetAgent:
      type: object
      required:
        - agent_id
        - name
      properties:
        agent_id:
          type: string
        name:
          type: string

    AuditSentimentChange:
      type: object
      properties:
        delta:
          type: number
          format: float
        reason:
          type: string

    AuditEventData:
      type: object
      properties:
        message:
          type: string
        tick:
          type: integer
          minimum: 0
        is_initiative:
          type: boolean
        action_result:
          type: string
          nullable: true
        sentiments:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/AuditSentimentChange'

    AuditSimulationContext:
      type: object
      properties:
        scenario_name:
          type: string
          examples:
            - "Необитаемый остров"
        current_topic:
          type: string
          nullable: true
        phase:
          type: string
          enum:
            - discuss
            - decide
            - act
            - conclude

    AuditEvent:
      type: object
      required:
        - event_type
        - source_agent
        - timestamp
      properties:
        event_type:
          type: string
          enum:
            - message_sent
            - new_topic
            - event_reaction
        source_agent:
          $ref: '#/components/schemas/AuditSourceAgent'
        target_agents:
          type: array
          items:
            $ref: '#/components/schemas/AuditTargetAgent'
        timestamp:
          type: string
          format: date-time
        data:
          $ref: '#/components/schemas/AuditEventData'
        simulation_context:
          $ref: '#/components/schemas/AuditSimulationContext'

    AuditEventAccepted:
      type: object
      properties:
        status:
          type: string
          examples:
            - "accepted"
        type:
          type: string
          examples:
            - "message_sent"
        timestamp:
          type: string
          format: date-time

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT токен аутентификации (содержит userId)

  responses:
    BadRequest:
      description: Incorrect credentials
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Conflict:
      description: User already registered
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    TooManyRequests:
      description: Too many requests
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Unauthorized:
      description: Access token can't be updated. Sign-in required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
