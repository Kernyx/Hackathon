"""
MVP: 3 AI-–∞–≥–µ–Ω—Ç–∞ –æ–±—â–∞—é—Ç—Å—è –º–µ–∂–¥—É —Å–æ–±–æ–π –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ.
–Ø–¥—Ä–æ ‚Äî LM Studio (OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π API) —Å –º–æ–¥–µ–ª—å—é qwen-3-14b-instruct.
"""

import sys
import os
import random
import time
import json
from dataclasses import dataclass, field, asdict
from typing import Optional
from pathlib import Path
from datetime import datetime
from enum import Enum

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UTF-8 –∫–æ–¥–∏—Ä–æ–≤–∫—É –¥–ª—è Windows
if sys.platform == 'win32':
    sys.stdout.reconfigure(encoding='utf-8')
    sys.stderr.reconfigure(encoding='utf-8')

from dotenv import load_dotenv
from openai import OpenAI, APITimeoutError, APIConnectionError, APIStatusError
from colorama import init, Fore, Style

load_dotenv()
init(autoreset=True)

import re as _re
from difflib import SequenceMatcher

def _text_similarity(a: str, b: str) -> float:
    """–ë—ã—Å—Ç—Ä–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–æ—Ö–æ–∂–µ—Å—Ç–∏ –¥–≤—É—Ö —Å—Ç—Ä–æ–∫ (0..1)."""
    a_lower = a.lower().strip()
    b_lower = b.lower().strip()
    if not a_lower or not b_lower:
        return 0.0
    return SequenceMatcher(None, a_lower, b_lower).ratio()

def _extract_phrases(text: str) -> set:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ n-–≥—Ä–∞–º–º—ã (3 —Å–ª–æ–≤–∞) –∏–∑ —Ç–µ–∫—Å—Ç–∞."""
    words = _re.findall(r'[–∞-—è—ëa-z]+', text.lower())
    if len(words) < 3:
        return set(words)
    return {' '.join(words[i:i+3]) for i in range(len(words)-2)}

def _has_repetitive_pattern(text: str, recent_texts: list) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑ –Ω–µ–¥–∞–≤–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π."""
    if not recent_texts:
        return False
    new_phrases = _extract_phrases(text)
    if not new_phrases:
        return False
    for prev_text in recent_texts[-6:]:
        prev_phrases = _extract_phrases(prev_text)
        if not prev_phrases:
            continue
        overlap = len(new_phrases & prev_phrases) / max(len(new_phrases), 1)
        if overlap > 0.4:
            return True
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —à–∞–±–ª–æ–Ω–Ω—ã–µ –Ω–∞—á–∞–ª–∞
    repetitive_starts = [
        '–∞ —á—Ç–æ, –µ—Å–ª–∏ –º—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ',
        '–∞ —á—Ç–æ –µ—Å–ª–∏ –º—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ',
        '–∞ —á—Ç–æ, –µ—Å–ª–∏ –≤–º–µ—Å—Ç–æ',
        '–∞ —á—Ç–æ –µ—Å–ª–∏ –≤–º–µ—Å—Ç–æ',
        '–∫—Ç–æ —Å–æ –º–Ω–æ–π',
        '–∫—Ç–æ –ø–µ—Ä–≤—ã–π',
        '–∫—Ç–æ –ø–µ—Ä–≤—ã–º',
        '–ø—É—Å—Ç—å ',
        '–¥–∞–≤–∞–π—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º',
    ]
    text_lower = text.lower().strip()
    start_matches = sum(1 for rt in recent_texts[-4:]
                        if any(rt.lower().strip().startswith(s) and text_lower.startswith(s)
                               for s in repetitive_starts))
    if start_matches >= 1:
        return True
    return False

# –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∫—Å–∏ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
os.environ['NO_PROXY'] = 'localhost,127.0.0.1'
os.environ['no_proxy'] = 'localhost,127.0.0.1'

# ‚îÄ‚îÄ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

LLM_BASE_URL = os.getenv("OLLAMA_BASE_URL", "http://localhost:1234/v1")
LLM_API_KEY = os.getenv("OLLAMA_API_KEY", "not-needed")
LLM_MODEL = os.getenv("OLLAMA_MODEL", "qwen-3-14b-instruct")

MAX_TICKS = 50          # —Å–∫–æ–ª—å–∫–æ —Ö–æ–¥–æ–≤ –¥–ª–∏—Ç—Å—è —Å–∏–º—É–ª—è—Ü–∏—è
TICK_DELAY = 1.0        # –ø–∞—É–∑–∞ –º–µ–∂–¥—É —Ö–æ–¥–∞–º–∏ (—Å–µ–∫)
MEMORY_WINDOW = 20      # —Å–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤–∏–¥–∏—Ç –∞–≥–µ–Ω—Ç
LLM_TIMEOUT = 60        # —Ç–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM (—Å–µ–∫)
LLM_MAX_RETRIES = 3     # –º–∞–∫—Å. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
LLM_RETRY_DELAY = 2.0   # –±–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É retry (—Å–µ–∫)

# –ü–∞–º—è—Ç—å
SHORT_TERM_MEMORY = 10  # –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π)
LONG_TERM_MEMORY = 50   # –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å (–≤–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã)
MEMORY_DB_PATH = "data/agent_memory.json"  # –ø—É—Ç—å –∫ –±–∞–∑–µ –ø–∞–º—è—Ç–∏
COMPRESSION_THRESHOLD = 30  # –ø–æ—Å–ª–µ —Å–∫–æ–ª—å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–µ–ª–∞—Ç—å —Å–∂–∞—Ç–∏–µ
SUMMARY_LENGTH = 5  # —Å–∫–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ –æ—Å—Ç–∞–≤–ª—è—Ç—å –ø—Ä–∏ —Å–∂–∞—Ç–∏–∏

# –¢–µ–º—ã –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
TOPIC_CHANGE_THRESHOLD = 10  # –ø–æ—Å–ª–µ —Å–∫–æ–ª—å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –æ–¥–Ω—É —Ç–µ–º—É –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –Ω–æ–≤—É—é
CREATIVITY_BOOST = 0.3      # —à–∞–Ω—Å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–æ–≤—É—é —Ç–µ–º—É –≤–º–µ—Å—Ç–æ –æ–±—ã—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
TOPIC_DB_PATH = "data/topics.json"  # –ø—É—Ç—å –∫ –±–∞–∑–µ —Ç–µ–º
REPETITION_SIMILARITY_THRESHOLD = 0.5  # –ø–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏ –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –ø–æ–≤—Ç–æ—Ä–æ–≤ (0-1)

# –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è
SCENARIO_EVENT_INTERVAL = 15  # –∫–∞–∂–¥—ã–µ N —Ç–∏–∫–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–æ–±—ã—Ç–∏–µ
SCENARIO_DB_PATH = "data/scenario.json"  # –ø—É—Ç—å –∫ —Ç–µ–∫—É—â–µ–º—É —Å—Ü–µ–Ω–∞—Ä–∏—é


# ‚îÄ‚îÄ LLM-–∫–ª–∏–µ–Ω—Ç ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

import httpx

# –°–æ–∑–¥–∞—ë–º HTTP –∫–ª–∏–µ–Ω—Ç –±–µ–∑ –ø—Ä–æ–∫—Å–∏ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
http_client = httpx.Client(
    timeout=httpx.Timeout(LLM_TIMEOUT, connect=10.0),
    proxy=None,  # –æ—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∫—Å–∏
)

client = OpenAI(
    base_url=LLM_BASE_URL,
    api_key=LLM_API_KEY,
    timeout=LLM_TIMEOUT,
    max_retries=0,  # retry –¥–µ–ª–∞–µ–º –≤—Ä—É—á–Ω—É—é –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è
    http_client=http_client,
)


def llm_chat(messages: list[dict], temperature: float = 0.8) -> Optional[str]:
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ LLM —Å retry –∏ —Ç–∞–π–º–∞—É—Ç–æ–º. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ."""
    # –î–æ–±–∞–≤–ª—è–µ–º /no_think –¥–ª—è qwen-3 —á—Ç–æ–±—ã –æ—Ç–∫–ª—é—á–∏—Ç—å think-—Ä–µ–∂–∏–º
    if messages and messages[0]["role"] == "system":
        if "/no_think" not in messages[0]["content"]:
            messages = messages.copy()
            messages[0] = messages[0].copy()
            messages[0]["content"] = "/no_think\n" + messages[0]["content"]
    
    for attempt in range(1, LLM_MAX_RETRIES + 1):
        try:
            resp = client.chat.completions.create(
                model=LLM_MODEL,
                messages=messages,
                temperature=temperature,
                max_tokens=300,  # —É–≤–µ–ª–∏—á–∏–ª–∏ —á—Ç–æ–±—ã —Ö–≤–∞—Ç–∏–ª–æ –ø–æ—Å–ª–µ think-–±–ª–æ–∫–æ–≤
            )
            return resp.choices[0].message.content.strip()

        except APITimeoutError:
            wait = LLM_RETRY_DELAY * attempt
            print(f"{Fore.RED}  ‚è± LLM —Ç–∞–π–º–∞—É—Ç (–ø–æ–ø—ã—Ç–∫–∞ {attempt}/{LLM_MAX_RETRIES}), –∂–¥—É {wait:.0f}—Å...{Style.RESET_ALL}")
            time.sleep(wait)

        except APIConnectionError as e:
            wait = LLM_RETRY_DELAY * attempt
            print(f"{Fore.RED}  ‚ö° LLM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–ø–æ–ø—ã—Ç–∫–∞ {attempt}/{LLM_MAX_RETRIES}): {e}{Style.RESET_ALL}")
            time.sleep(wait)

        except APIStatusError as e:
            if e.status_code == 429:  # Too Many Requests
                wait = LLM_RETRY_DELAY * attempt * 2  # –∂–¥—ë–º –¥–æ–ª—å—à–µ –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ
                print(f"{Fore.RED}  üî• LLM –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω (429), –∂–¥—É {wait:.0f}—Å...{Style.RESET_ALL}")
                time.sleep(wait)
            elif e.status_code >= 500:  # —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞ LM Studio
                wait = LLM_RETRY_DELAY * attempt
                print(f"{Fore.RED}  üí• LLM –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ ({e.status_code}), –∂–¥—É {wait:.0f}—Å...{Style.RESET_ALL}")
                time.sleep(wait)
            else:
                print(f"{Fore.RED}  ‚ùå LLM –æ—à–∏–±–∫–∞ {e.status_code}: {e.message}{Style.RESET_ALL}")
                return None

        except Exception as e:
            print(f"{Fore.RED}  ‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}{Style.RESET_ALL}")
            return None

    print(f"{Fore.RED}  ‚ùå LLM –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –ø–æ—Å–ª–µ {LLM_MAX_RETRIES} –ø–æ–ø—ã—Ç–æ–∫, –ø—Ä–æ–ø—É—Å–∫–∞—é —Ö–æ–¥.{Style.RESET_ALL}")
    return None


# ‚îÄ‚îÄ –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (Big Five & Personality) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

class PersonalityType(Enum):
    """–¢–∏–ø—ã –ª–∏—á–Ω–æ—Å—Ç–∏ –∞–≥–µ–Ω—Ç–∞."""
    ALTRUIST = "–ê–ª—å—Ç—Ä—É–∏—Å—Ç (–¥–æ–±—Ä—ã–π)"
    MACHIAVELLIAN = "–ú–∞–∫–∏–∞–≤–µ–ª–ª–∏—Å—Ç (–∑–ª–æ–π)"
    REBEL = "–ë—É–Ω—Ç–∞—Ä—å (–Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π)"
    STOIC = "–°—Ç–æ–∏–∫ (—Ö–ª–∞–¥–Ω–æ–∫—Ä–æ–≤–Ω—ã–π)"
    INDIVIDUAL = "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π)"


@dataclass
class BigFiveTraits:
    """–ú–æ–¥–µ–ª—å Big Five (–ë–æ–ª—å—à–∞—è –ø—è—Ç—ë—Ä–∫–∞ —á–µ—Ä—Ç –ª–∏—á–Ω–æ—Å—Ç–∏)."""
    openness: int = 50              # –û—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å –Ω–æ–≤–æ–º—É (0-100)
    conscientiousness: int = 50     # –î–æ–±—Ä–æ—Å–æ–≤–µ—Å—Ç–Ω–æ—Å—Ç—å/–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω–æ—Å—Ç—å (0-100)
    extraversion: int = 50          # –≠–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏—è/–æ–±—â–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (0-100)
    agreeableness: int = 50         # –î–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å/—Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤—É (0-100)
    neuroticism: int = 50           # –ù–µ–π—Ä–æ—Ç–∏–∑–º/—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (0-100)
    
    def to_description(self) -> str:
        """–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞."""
        traits = []
        
        if self.openness > 70:
            traits.append("–æ—á–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç –Ω–æ–≤–æ–º—É –æ–ø—ã—Ç—É –∏ –∏–¥–µ—è–º")
        elif self.openness < 30:
            traits.append("–ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã")
        
        if self.conscientiousness > 70:
            traits.append("–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω –∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∏—Ä–æ–≤–∞–Ω")
        elif self.conscientiousness < 30:
            traits.append("—Å–ø–æ–Ω—Ç–∞–Ω–µ–Ω –∏ –≥–∏–±–æ–∫")
        
        if self.extraversion > 70:
            traits.append("—ç–Ω–µ—Ä–≥–∏—á–µ–Ω –∏ –æ–±—â–∏—Ç–µ–ª–µ–Ω")
        elif self.extraversion < 30:
            traits.append("—Å–¥–µ—Ä–∂–∞–Ω –∏ –∑–∞–¥—É–º—á–∏–≤")
        
        if self.agreeableness > 70:
            traits.append("–¥—Ä—É–∂–µ–ª—é–±–µ–Ω –∏ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å")
        elif self.agreeableness < 30:
            traits.append("–∫—Ä–∏—Ç–∏—á–µ–Ω –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º")
        
        if self.neuroticism > 70:
            traits.append("—ç–º–æ—Ü–∏–æ–Ω–∞–ª–µ–Ω –∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω")
        elif self.neuroticism < 30:
            traits.append("—Å–ø–æ–∫–æ–µ–Ω –∏ —Å—Ç–∞–±–∏–ª–µ–Ω")
        
        return ", ".join(traits) if traits else "—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–∏—á–Ω–æ—Å—Ç—å"
    
    @staticmethod
    def from_personality_type(ptype: PersonalityType) -> 'BigFiveTraits':
        """–°–æ–∑–¥–∞—Ç—å Big Five –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ —Ç–∏–ø–∞ –ª–∏—á–Ω–æ—Å—Ç–∏."""
        profiles = {
            PersonalityType.ALTRUIST: BigFiveTraits(
                openness=70, conscientiousness=60, extraversion=65,
                agreeableness=85, neuroticism=35
            ),
            PersonalityType.MACHIAVELLIAN: BigFiveTraits(
                openness=55, conscientiousness=70, extraversion=50,
                agreeableness=25, neuroticism=40
            ),
            PersonalityType.REBEL: BigFiveTraits(
                openness=85, conscientiousness=30, extraversion=60,
                agreeableness=40, neuroticism=65
            ),
            PersonalityType.STOIC: BigFiveTraits(
                openness=45, conscientiousness=75, extraversion=30,
                agreeableness=50, neuroticism=20
            ),
            PersonalityType.INDIVIDUAL: BigFiveTraits(),  # —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
        }
        return profiles.get(ptype, BigFiveTraits())


# ‚îÄ‚îÄ –°–∏—Å—Ç–µ–º–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏ —Å–æ–±—ã—Ç–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

@dataclass
class Scenario:
    """–°—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è —Ä–æ–ª–µ–≤–æ–π –∏–≥—Ä—ã."""
    name: str
    description: str  # –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏
    context: str      # –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞ –∞–≥–µ–Ω—Ç–æ–≤
    events: list[str] = field(default_factory=list)  # –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
    current_event_index: int = 0


class ScenarioManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏ –∏ —Å–æ–±—ã—Ç–∏—è–º–∏."""
    
    SCENARIOS = {
        "desert_island": Scenario(
            name="–ù–µ–æ–±–∏—Ç–∞–µ–º—ã–π –æ—Å—Ç—Ä–æ–≤",
            description="–í—ã –æ–∫–∞–∑–∞–ª–∏—Å—å –Ω–∞ –Ω–µ–æ–±–∏—Ç–∞–µ–º–æ–º –æ—Å—Ç—Ä–æ–≤–µ –ø–æ—Å–ª–µ –∫—Ä—É—à–µ–Ω–∏—è —Å–∞–º–æ–ª—ë—Ç–∞",
            context=(
                "–í—ã –æ–∫–∞–∑–∞–ª–∏—Å—å –Ω–∞ –Ω–µ–æ–±–∏—Ç–∞–µ–º–æ–º —Ç—Ä–æ–ø–∏—á–µ—Å–∫–æ–º –æ—Å—Ç—Ä–æ–≤–µ –ø–æ—Å–ª–µ –∞–≤–∏–∞–∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—ã. "
                "–†—è–¥–æ–º –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç, —Ç–æ–ª—å–∫–æ –≤—ã —Ç—Ä–æ–µ. –ù—É–∂–Ω–æ –≤—ã–∂–∏–≤–∞—Ç—å, –Ω–∞—Ö–æ–¥–∏—Ç—å –µ–¥—É –∏ –≤–æ–¥—É, "
                "—Å—Ç—Ä–æ–∏—Ç—å —É–∫—Ä—ã—Ç–∏–µ –∏ –∏—Å–∫–∞—Ç—å —Å–ø–æ—Å–æ–± —Å–ø–∞—Å—Ç–∏—Å—å. –£ –∫–∞–∂–¥–æ–≥–æ —Å–≤–æ–∏ –Ω–∞–≤—ã–∫–∏ –∏ —Å—Ç—Ä–∞—Ö–∏."
            ),
            events=[
                "üåßÔ∏è –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ç—Ä–æ–ø–∏—á–µ—Å–∫–∏–π –ª–∏–≤–µ–Ω—å. –ù—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ –Ω–∞–π—Ç–∏ —É–∫—Ä—ã—Ç–∏–µ!",
                "üî• –ö—Ç–æ-—Ç–æ —Å–ª—É—á–∞–π–Ω–æ —Ä–∞–∑–∂—ë–≥ –∫–æ—Å—Ç—ë—Ä. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–ª–µ—á—å —Å–ø–∞—Å–∞—Ç–µ–ª–µ–π... –∏–ª–∏ —Ö–∏—â–Ω–∏–∫–æ–≤.",
                "ü•• –ù–∞–π–¥–µ–Ω—ã –∫–æ–∫–æ—Å—ã –∏ —Å—Ç—Ä–∞–Ω–Ω—ã–µ —Ñ—Ä—É–∫—Ç—ã. –ö—Ç–æ —Ä–∏—Å–∫–Ω—ë—Ç –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å?",
                "ü¶Ä –ù–∞ –±–µ—Ä–µ–≥ –≤—ã–ø–æ–ª–∑–ª–∏ –∫—Ä–∞–±—ã. –ú–æ–∂–µ—Ç, —ç—Ç–æ —É–∂–∏–Ω?",
                "üì° –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ–±–ª–æ–º–∫–∏ —Å–∞–º–æ–ª—ë—Ç–∞ —Å —Ä–∞—Ü–∏–µ–π. –û–Ω–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞, –Ω–æ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.",
                "üåä –ü—Ä–∏–ª–∏–≤ —Å–º—ã–≤–∞–µ—Ç –ø–æ–ª–æ–≤–∏–Ω—É –ª–∞–≥–µ—Ä—è. –ü—Ä–∏–¥—ë—Ç—Å—è –≤—Å—ë –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞—Ç—å.",
                "üêç –ö—Ç–æ-—Ç–æ –∑–∞–º–µ—Ç–∏–ª –∑–º–µ—é –≤ –∫—É—Å—Ç–∞—Ö. –Ø–¥–æ–≤–∏—Ç–∞—è –∏–ª–∏ –Ω–µ—Ç?",
                "‚õµ –ù–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ –ø–æ–∫–∞–∑–∞–ª—Å—è –∫–æ—Ä–∞–±–ª—å! –ù–æ –æ–Ω —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ...",
                "üåÖ –ü—Ä–µ–∫—Ä–∞—Å–Ω—ã–π –∑–∞–∫–∞—Ç. –ú–æ–∂–µ—Ç, —Å—Ç–æ–∏—Ç –æ—Ç–¥–æ—Ö–Ω—É—Ç—å –∏ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –ø–æ –¥—É—à–∞–º?",
                "üí® –°–∏–ª—å–Ω—ã–π –≤–µ—Ç–µ—Ä –º–æ–∂–µ—Ç –æ–∑–Ω–∞—á–∞—Ç—å –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ —à—Ç–æ—Ä–º–∞.",
            ]
        ),
        "space_station": Scenario(
            name="–ö–æ—Å–º–∏—á–µ—Å–∫–∞—è —Å—Ç–∞–Ω—Ü–∏—è",
            description="–í—ã –≤ –∏–∑–æ–ª—è—Ü–∏–∏ –Ω–∞ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π —Å—Ç–∞–Ω—Ü–∏–∏, —Å–≤—è–∑—å —Å –ó–µ–º–ª—ë–π –ø–æ—Ç–µ—Ä—è–Ω–∞",
            context=(
                "–í—ã ‚Äî —ç–∫–∏–ø–∞–∂ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π —Å—Ç–∞–Ω—Ü–∏–∏ –Ω–∞ –æ—Ä–±–∏—Ç–µ –ú–∞—Ä—Å–∞. –°–≤—è–∑—å —Å –ó–µ–º–ª—ë–π –ø—Ä–µ—Ä–≤–∞–ª–∞—Å—å —Ç—Ä–∏ –¥–Ω—è –Ω–∞–∑–∞–¥. "
                "–ó–∞–ø–∞—Å—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã, —Å–∏—Å—Ç–µ–º—ã –∂–∏–∑–Ω–µ–æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ. "
                "–í—ã –æ–¥–Ω–∏ –≤ –∫–æ—Å–º–æ—Å–µ, –∏ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ, –∫–æ–≥–¥–∞ –ø—Ä–∏–¥—ë—Ç –ø–æ–º–æ—â—å."
            ),
            events=[
                "‚ö†Ô∏è –°–∏—Å—Ç–µ–º–∞ –∂–∏–∑–Ω–µ–æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –≤—ã–¥–∞—ë—Ç –æ—à–∏–±–∫—É. –£—Ä–æ–≤–µ–Ω—å –∫–∏—Å–ª–æ—Ä–æ–¥–∞ –ø–∞–¥–∞–µ—Ç!",
                "üõ∞Ô∏è –ü–æ–π–º–∞–ª–∏ —Å–ª–∞–±—ã–π —Å–∏–≥–Ω–∞–ª —Å –ó–µ–º–ª–∏, –Ω–æ –Ω–µ –º–æ–∂–µ–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Å–ª–æ–≤–∞.",
                "üåå –í –∏–ª–ª—é–º–∏–Ω–∞—Ç–æ—Ä–µ –≤–∏–¥–Ω–∞ –∫—Ä–∞—Å–Ω–∞—è –ø–ª–∞–Ω–µ—Ç–∞. –ó–∞–≤–æ—Ä–∞–∂–∏–≤–∞—é—â–µ–µ –∑—Ä–µ–ª–∏—â–µ.",
                "‚ö° –°–æ–ª–Ω–µ—á–Ω–∞—è –≤—Å–ø—ã—à–∫–∞ –ø–æ–≤—Ä–µ–¥–∏–ª–∞ –ø–∞–Ω–µ–ª–∏. –≠–Ω–µ—Ä–≥–∏—è –Ω–∞ –∏—Å—Ö–æ–¥–µ.",
                "üç± –ó–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è –∑–∞–ø–∞—Å—ã –µ–¥—ã. –ü—Ä–∏–¥—ë—Ç—Å—è –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –ø–∞–π–∫–∏.",
                "üîß –ß—Ç–æ-—Ç–æ —Å—Ç—É—á–∏—Ç –≤ –æ—Ç—Å–µ–∫–µ. –ú–µ—Ç–µ–æ—Ä–∏—Ç? –ò–ª–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ª–æ–º–∞–µ—Ç—Å—è?",
                "üìä –ö–æ–º–ø—å—é—Ç–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å.",
                "üå† –ó–∞ –æ–∫–Ω–æ–º –ø—Ä–æ–ª–µ—Ç–∞–µ—Ç –º–µ—Ç–µ–æ—Ä–∏—Ç–Ω—ã–π –¥–æ–∂–¥—å. –ö—Ä–∞—Å–∏–≤–æ, –Ω–æ –æ–ø–∞—Å–Ω–æ.",
                "üí§ –ö—Ç–æ-—Ç–æ –Ω–∞—á–∞–ª –≤–∏–¥–µ—Ç—å —Å—Ç—Ä–∞–Ω–Ω—ã–µ —Å–Ω—ã. –ò–∑–æ–ª—è—Ü–∏—è –¥–∞—ë—Ç –æ —Å–µ–±–µ –∑–Ω–∞—Ç—å.",
                "üì° –†–∞–¥–∞—Ä –∑–∞—Å—ë–∫ –Ω–µ–æ–ø–æ–∑–Ω–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç. –û–Ω –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è...",
            ]
        ),
        "zombie_apocalypse": Scenario(
            name="–ó–æ–º–±–∏-–∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å",
            description="–ú–∏—Ä –∑–∞—Ö–≤–∞—á–µ–Ω –∑–æ–º–±–∏, –≤—ã —É–∫—Ä—ã–ª–∏—Å—å –≤ –∑–∞–±—Ä–æ—à–µ–Ω–Ω–æ–º —Ç–æ—Ä–≥–æ–≤–æ–º —Ü–µ–Ω—Ç—Ä–µ",
            context=(
                "–ó–æ–º–±–∏-–∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å. –ì–æ—Ä–æ–¥–∞ —Ä–∞–∑—Ä—É—à–µ–Ω—ã, –≤—ã–∂–∏–≤—à–∏—Ö –º–∞–ª–æ. "
                "–í—ã –≤—Ç—Ä–æ—ë–º –∑–∞–Ω—è–ª–∏ –æ–±–æ—Ä–æ–Ω—É –≤ –∑–∞–±—Ä–æ—à–µ–Ω–Ω–æ–º —Ç–æ—Ä–≥–æ–≤–æ–º —Ü–µ–Ω—Ç—Ä–µ. "
                "–ó–∞–ø–∞—Å—ã –µ—Å—Ç—å, –Ω–æ –¥–æ–ª–≥–æ –Ω–µ –ø—Ä–æ—Ç—è–Ω—É—Ç. –ó–æ–º–±–∏ —Å–Ω–∞—Ä—É–∂–∏, –∏ –∏—Ö —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤—Å—ë –±–æ–ª—å—à–µ."
            ),
            events=[
                "üßü –°–ª—ã—à–µ–Ω –≥—Ä–æ—Ö–æ—Ç ‚Äî –∑–æ–º–±–∏ –ø—ã—Ç–∞—é—Ç—Å—è –≤—ã–ª–æ–º–∞—Ç—å –¥–≤–µ—Ä—å!",
                "üì¶ –ù–∞—à–ª–∏ —Å–∫–ª–∞–¥ —Å –∫–æ–Ω—Å–µ—Ä–≤–∞–º–∏. –•–≤–∞—Ç–∏—Ç –Ω–∞ –º–µ—Å—è—Ü!",
                "üî´ –û–±–Ω–∞—Ä—É–∂–µ–Ω –æ—Ä—É–∂–µ–π–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω, –Ω–æ —Ç—É–¥–∞ –æ–ø–∞—Å–Ω–æ –∏–¥—Ç–∏.",
                "üìª –ü–æ —Ä–∞–¥–∏–æ –ø–µ—Ä–µ–¥–∞—é—Ç —Å–∏–≥–Ω–∞–ª SOS –∏–∑ —Å–æ—Å–µ–¥–Ω–µ–≥–æ —Ä–∞–π–æ–Ω–∞.",
                "üíä –ö—Ç–æ-—Ç–æ –∑–∞–±–æ–ª–µ–ª. –ü—Ä–æ—Å—Ç—É–¥–∞ –∏–ª–∏... —É–∫—É—Å –∑–æ–º–±–∏?",
                "üî¶ –ë–∞—Ç–∞—Ä–µ–π–∫–∏ –∫–æ–Ω—á–∞—é—Ç—Å—è. –°–∫–æ—Ä–æ –æ—Å—Ç–∞–Ω–µ–º—Å—è –±–µ–∑ —Å–≤–µ—Ç–∞.",
                "üöÅ –°–ª—ã—à–µ–Ω –∑–≤—É–∫ –≤–µ—Ä—Ç–æ–ª—ë—Ç–∞! –ù–æ –æ–Ω –ø—Ä–æ–ª–µ—Ç–µ–ª –º–∏–º–æ...",
                "üóùÔ∏è –ù–∞–π–¥–µ–Ω –∫–ª—é—á –æ—Ç –∑–∞–ø–∞—Å–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞. –ú–æ–∂–µ—Ç, —Å—Ç–æ–∏—Ç —Ä–∏—Å–∫–Ω—É—Ç—å?",
                "üåô –¢–∏—Ö–∞—è –Ω–æ—á—å. –ó–æ–º–±–∏ –ø–æ—á—Ç–∏ –Ω–µ —Å–ª—ã—à–Ω–æ. –í—Ä–µ–º—è –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å.",
                "‚ö†Ô∏è –ö—Ç–æ-—Ç–æ –≤–∏–¥–µ–ª –∂–∏–≤—ã—Ö –ª—é–¥–µ–π –∑–∞ –æ–∫–Ω–æ–º. –î—Ä—É–∑—å—è –∏–ª–∏ –±–∞–Ω–¥–∏—Ç—ã?",
            ]
        ),
        "medieval_tavern": Scenario(
            name="–°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤–∞—è —Ç–∞–≤–µ—Ä–Ω–∞",
            description="–í—ã ‚Äî –ø—É—Ç–Ω–∏–∫–∏, –≤—Å—Ç—Ä–µ—Ç–∏–≤—à–∏–µ—Å—è –≤ —Ç–∞–≤–µ—Ä–Ω–µ –ø–µ—Ä–µ–¥ –æ–ø–∞—Å–Ω—ã–º –∫–≤–µ—Å—Ç–æ–º",
            context=(
                "–°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—ã–π —Ñ—ç–Ω—Ç–µ–∑–∏–π–Ω—ã–π –º–∏—Ä. –í—ã ‚Äî –ø—É—Ç–Ω–∏–∫–∏ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ—Ñ–µ—Å—Å–∏–π, "
                "–≤—Å—Ç—Ä–µ—Ç–∏–≤—à–∏–µ—Å—è –≤ —à—É–º–Ω–æ–π —Ç–∞–≤–µ—Ä–Ω–µ '–ü—å—è–Ω—ã–π –¥—Ä–∞–∫–æ–Ω'. "
                "–ó–∞–≤—Ç—Ä–∞ –≤–∞—Å –∂–¥—ë—Ç –æ–ø–∞—Å–Ω—ã–π –∫–≤–µ—Å—Ç –≤ —Ç—ë–º–Ω—ã–π –ª–µ—Å. –ú–æ–∂–µ—Ç, —Å—Ç–æ–∏—Ç –ø–æ–ª—É—á—à–µ —É–∑–Ω–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞?"
            ),
            events=[
                "üç∫ –ë–∞—Ä–º–µ–Ω –ø—Ä–∏–Ω–æ—Å–∏—Ç —ç–ª—å. –ú–æ–∂–µ—Ç, –≤—ã–ø—å–µ–º –∏ —Ä–∞—Å—Å–∫–∞–∂–µ–º –æ —Å–µ–±–µ?",
                "‚öîÔ∏è –í —Ç–∞–≤–µ—Ä–Ω—É –≤—Ä—ã–≤–∞—é—Ç—Å—è –±–∞–Ω–¥–∏—Ç—ã! –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –¥—Ä–∞–∫–∞!",
                "üé≤ –ö—Ç–æ-—Ç–æ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å—ã–≥—Ä–∞—Ç—å –≤ –∫–æ—Å—Ç–∏ –Ω–∞ –¥–µ–Ω—å–≥–∏.",
                "üéµ –ë–∞—Ä–¥ –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–µ—Ç—å –≥—Ä—É—Å—Ç–Ω—É—é –±–∞–ª–ª–∞–¥—É –æ –ø–∞–≤—à–∏—Ö –≥–µ—Ä–æ—è—Ö.",
                "üó∫Ô∏è –ú–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ä–∏–∫ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∫–∞—Ä—Ç—É —Å —Å–æ–∫—Ä–æ–≤–∏—â–∞–º–∏. –í–µ—Ä–∏—Ç—å –ª–∏ –µ–º—É?",
                "üîÆ –ì–∞–¥–∞–ª–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–º –ø–æ—Ö–æ–¥–µ.",
                "üçñ –ü—Ä–∏–Ω–æ—Å—è—Ç –≥–æ—Ä—è—á–µ–µ –∂–∞—Ä–∫–æ–µ. –í—Ä–µ–º—è –ø–æ–µ—Å—Ç—å –∏ –ø–æ–±–æ–ª—Ç–∞—Ç—å.",
                "üë§ –ó–∞–≥–∞–¥–æ—á–Ω—ã–π –Ω–µ–∑–Ω–∞–∫–æ–º–µ—Ü —Å–ª—É—à–∞–µ—Ç –≤–∞—à —Ä–∞–∑–≥–æ–≤–æ—Ä –∏–∑ —É–≥–ª–∞.",
                "‚ö° –ì—Ä–æ–∑–∞ –∑–∞ –æ–∫–Ω–æ–º. –ü–æ—Ö–æ–∂–µ, –∑–∞–≤—Ç—Ä–∞ –±—É–¥–µ—Ç –ø–ª–æ—Ö–∞—è –ø–æ–≥–æ–¥–∞.",
                "üåô –ü–æ–∑–¥–Ω—è—è –Ω–æ—á—å. –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π —Ä–∞–∑–æ—à–ª–∏—Å—å. –¢–æ–ª—å–∫–æ –≤—ã –∏ —Ç–∏—à–∏–Ω–∞.",
            ]
        ),
    }
    
    def __init__(self, scenario_name: str = "desert_island", db_path: str = SCENARIO_DB_PATH):
        self.db_path = Path(db_path)
        self.current_scenario = self.SCENARIOS.get(scenario_name, self.SCENARIOS["desert_island"])
        self.events_triggered: list[str] = []
        
        # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
        self.db_path.parent.mkdir(parents=True, exist_ok=True)
        self.load_from_db()
    
    def get_scenario_context(self) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ–∫—É—â–µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞."""
        context = f"\nüé≠ –°–¶–ï–ù–ê–†–ò–ô: {self.current_scenario.name}\n"
        context += f"{self.current_scenario.context}\n"
        
        if self.events_triggered:
            context += f"\n–ü—Ä–æ–∏–∑–æ—à–µ–¥—à–∏–µ —Å–æ–±—ã—Ç–∏—è: {', '.join(self.events_triggered[-3:])}\n"
        
        return context
    
    def trigger_random_event(self) -> Optional[str]:
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏–∑ —Å—Ü–µ–Ω–∞—Ä–∏—è."""
        if not self.current_scenario.events:
            return None
        
        # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
        available_events = [e for e in self.current_scenario.events if e not in self.events_triggered[-3:]]
        
        if not available_events:
            available_events = self.current_scenario.events
        
        event = random.choice(available_events)
        self.events_triggered.append(event)
        self.save_to_db()
        
        return event
    
    def save_to_db(self):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è."""
        data = {
            "scenario_name": self.current_scenario.name,
            "events_triggered": self.events_triggered,
            "last_updated": datetime.now().isoformat(),
        }
        
        with open(self.db_path, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
    
    def load_from_db(self):
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è."""
        if not self.db_path.exists():
            return
        
        try:
            with open(self.db_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            self.events_triggered = data.get("events_triggered", [])
            
        except Exception as e:
            print(f"{Fore.YELLOW}‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π: {e}{Style.RESET_ALL}")


# ‚îÄ‚îÄ –°–∏—Å—Ç–µ–º–∞ —Ç–µ–º –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

class TopicManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–∞–º–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è."""
    
    def __init__(self, db_path: str = TOPIC_DB_PATH):
        self.db_path = Path(db_path)
        self.current_topic: Optional[str] = None
        self.messages_on_topic: int = 0
        self.discussed_topics: list[str] = []
        
        # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
        self.db_path.parent.mkdir(parents=True, exist_ok=True)
        self.load_from_db()
    
    def generate_new_topic_llm(self, scenario_context: str = "") -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é —Ç–µ–º—É —á–µ—Ä–µ–∑ LLM."""
        # –ö–æ–Ω—Ç–µ–∫—Å—Ç –æ–±—Å—É–∂–¥—ë–Ω–Ω—ã—Ö —Ç–µ–º
        discussed_context = ""
        if self.discussed_topics:
            recent_topics = self.discussed_topics[-3:]
            discussed_context = f"\n\n–ù–µ–¥–∞–≤–Ω–æ –æ–±—Å—É–∂–¥–∞–ª–∏—Å—å —Ç–µ–º—ã: {', '.join(recent_topics)}"
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è
        scenario_info = ""
        if scenario_context:
            scenario_info = f"\n\n–ö–û–ù–¢–ï–ö–°–¢ –°–¶–ï–ù–ê–†–ò–Ø:\n{scenario_context}\n–¢–µ–º–∞ –î–û–õ–ñ–ù–ê –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å —ç—Ç–∏–º —Å—Ü–µ–Ω–∞—Ä–∏–µ–º!"
        
        prompt = [
            {
                "role": "system",
                "content": (
                    "–¢—ã ‚Äî –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –º–æ–¥–µ—Ä–∞—Ç–æ—Ä –¥–∏—Å–∫—É—Å—Å–∏–π.\n"
                    f"{scenario_info}\n"
                    "–¢–µ–º—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:\n"
                    "- –ö–û–ù–ö–†–ï–¢–ù–´–ú–ò –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ (–ø—Ä–æ –¥–µ–π—Å—Ç–≤–∏—è, –ø—Ä–µ–¥–º–µ—Ç—ã, —Ä–µ—à–µ–Ω–∏—è)\n"
                    "- –°–≤—è–∑–∞–Ω–Ω—ã–º–∏ —Å —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π —Å—Ü–µ–Ω–∞—Ä–∏—è\n"
                    "- –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∫ –¥–µ–π—Å—Ç–≤–∏—é\n"
                    "- –ö–æ—Ä–æ—Ç–∫–∏–º–∏ (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)\n\n"
                    "–•–û–†–û–®–ò–ï –ø—Ä–∏–º–µ—Ä—ã —Ç–µ–º:\n"
                    "- '–ù–∞–º –Ω—É–∂–Ω–æ —Ä–µ—à–∏—Ç—å, –∫—Ç–æ –±—É–¥–µ—Ç –¥–µ–∂—É—Ä–∏—Ç—å –Ω–æ—á—å—é'\n"
                    "- '–Ø —Å–ª—ã—à—É —Å—Ç—Ä–∞–Ω–Ω—ã–µ –∑–≤—É–∫–∏ –∏–∑ –ø–æ–¥–≤–∞–ª–∞ ‚Äî –Ω–∞–¥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å'\n"
                    "- '–ï–¥—ã –æ—Å—Ç–∞–ª–æ—Å—å –Ω–∞ —Ç—Ä–∏ –¥–Ω—è, —á—Ç–æ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å?'\n\n"
                    "–ü–õ–û–•–ò–ï –ø—Ä–∏–º–µ—Ä—ã (–ù–ï –ò–°–ü–û–õ–¨–ó–£–ô):\n"
                    "- '–ê —á—Ç–æ, –µ—Å–ª–∏ –º—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ –≤—ã–∂–∏–≤–∞–µ–º...' ‚Äî —Å–ª–∏—à–∫–æ–º –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ\n"
                    "- '–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –Ω–∞—Å –ª—é–¥—å–º–∏?' ‚Äî —Å–ª–∏—à–∫–æ–º —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏\n"
                    f"{discussed_context}\n"
                    "–ü—Ä–µ–¥–ª–æ–∂–∏ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –Ω–æ–≤—É—é —Ç–µ–º—É, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—é—â—É—é –ø—Ä–µ–¥—ã–¥—É—â–∏–µ.\n\n"
                    "–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:\n"
                    "- –ü–∏—à–∏ –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ\n"
                    "- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫\n"
                    "- –ù–ï –¥—É–º–∞–π –≤—Å–ª—É—Ö\n"
                    "- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ–≥–∏ <think>, </think> –∏–ª–∏ –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Ç–µ–≥–∏\n"
                    "- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç —Ç–µ–º—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π"
                )
            },
            {
                "role": "user",
                "content": "–ü—Ä–µ–¥–ª–æ–∂–∏ –Ω–æ–≤—É—é –ö–û–ù–ö–†–ï–¢–ù–£–Æ —Ç–µ–º—É –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï. –¢–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–æ –¥–µ–π—Å—Ç–≤–∏—è –∏–ª–∏ —Ä–µ—à–µ–Ω–∏—è, –∞ –Ω–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–π —Ñ–∏–ª–æ—Å–æ—Ñ–∏–µ–π. –¢–æ–ª—å–∫–æ —Ç–µ–º—É, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–ª–æ–≤."
            }
        ]
        
        topic = llm_chat(prompt, temperature=0.9)
        if not topic:
            # Fallback —Ç–µ–º—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è
            if "–∑–æ–º–±–∏" in scenario_context.lower():
                fallback_topics = [
                    "–∫–∞–∫ –≤—ã –¥—É–º–∞–µ—Ç–µ, —Å–º–æ–∂–µ–º –ª–∏ –º—ã –ø—Ä–æ–¥–µ—Ä–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å –º–µ—Å—è—Ü?",
                    "—Å—Ç–æ–∏—Ç –ª–∏ —Ä–∏—Å–∫–æ–≤–∞—Ç—å –∏ –∏—Å–∫–∞—Ç—å –¥—Ä—É–≥–∏—Ö –≤—ã–∂–∏–≤—à–∏—Ö?",
                    "—á—Ç–æ –≤—ã –±—É–¥–µ—Ç–µ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –æ–¥–∏–Ω –∏–∑ –Ω–∞—Å —É–∫—É—à–µ–Ω?",
                ]
            elif "–æ—Å—Ç—Ä–æ–≤" in scenario_context.lower():
                fallback_topics = [
                    "–∫–∞–∫ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —É–∫—Ä—ã—Ç–∏–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∂–∏—Ç—å —à—Ç–æ—Ä–º?",
                    "—Å—Ç–æ–∏—Ç –ª–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –¥–∂—É–Ω–≥–ª–∏ –∏–ª–∏ –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –Ω–∞ –±–µ—Ä–µ–≥—É?",
                    "—á—Ç–æ –≤–∞–∂–Ω–µ–µ ‚Äî –Ω–∞–π—Ç–∏ –≤–æ–¥—É –∏–ª–∏ —Ä–∞–∑–∂–µ—á—å —Å–∏–≥–Ω–∞–ª—å–Ω—ã–π –∫–æ—Å—Ç—ë—Ä?",
                ]
            elif "–∫–æ—Å–º–∏—á–µ—Å–∫–∞—è" in scenario_context.lower() or "—Å—Ç–∞–Ω—Ü–∏—è" in scenario_context.lower():
                fallback_topics = [
                    "—á—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –∫–∏—Å–ª–æ—Ä–æ–¥ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é?",
                    "—Å—Ç–æ–∏—Ç –ª–∏ –ø—ã—Ç–∞—Ç—å—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∏–≥–Ω–∞–ª –±–µ–¥—Å—Ç–≤–∏—è –≤ –∫–æ—Å–º–æ—Å?",
                    "–∫–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—Å—É–¥–æ–∫ –≤ –ø–æ–ª–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏?",
                ]
            elif "—Ç–∞–≤–µ—Ä–Ω" in scenario_context.lower():
                fallback_topics = [
                    "–∫–æ–º—É –∏–∑ –Ω–∞—Å –º–æ–∂–Ω–æ –¥–æ–≤–µ—Ä—è—Ç—å –≤ –æ–ø–∞—Å–Ω–æ–º –∫–≤–µ—Å—Ç–µ?",
                    "—á—Ç–æ –≤–∞–∂–Ω–µ–µ ‚Äî –∑–æ–ª–æ—Ç–æ –∏–ª–∏ —á–µ—Å—Ç—å?",
                    "—Å—Ç–æ–∏—Ç –ª–∏ —Ä–∏—Å–∫–æ–≤–∞—Ç—å –∂–∏–∑–Ω—å—é —Ä–∞–¥–∏ —Å–ª–∞–≤—ã?",
                ]
            else:
                fallback_topics = [
                    "—á—Ç–æ –¥–ª—è –≤–∞—Å –∑–Ω–∞—á–∏—Ç –Ω–∞—Å—Ç–æ—è—â–∞—è –¥—Ä—É–∂–±–∞?",
                    "–∫–∞–∫ –≤—ã —Å–ø—Ä–∞–≤–ª—è–µ—Ç–µ—Å—å —Å —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º–∏?",
                    "–≤–æ —á—Ç–æ –≤—ã –≤–µ—Ä–∏—Ç–µ?",
                ]
            topic = random.choice(fallback_topics)
        
        # –û—á–∏—â–∞–µ–º –æ—Ç <think> —Ç–µ–≥–æ–≤
        import re
        topic = re.sub(r'<think>.*?</think>', '', topic, flags=re.DOTALL | re.IGNORECASE)
        topic = re.sub(r'<think>.*', '', topic, flags=re.DOTALL | re.IGNORECASE)
        topic = re.sub(r'</?think>', '', topic, flags=re.IGNORECASE)
        
        # –û—á–∏—â–∞–µ–º –æ—Ç –∫–∞–≤—ã—á–µ–∫ –∏ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
        topic = topic.strip().strip('"\'').lower()
        
        # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω—å—à–µ 5 —Å–∏–º–≤–æ–ª–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
        if len(topic) < 5:
            # –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ fallback —Ç–µ–º—ã
            if "–∑–æ–º–±–∏" in scenario_context.lower():
                topic = random.choice([
                    "–∫–∞–∫ –≤—ã –¥—É–º–∞–µ—Ç–µ, —Å–º–æ–∂–µ–º –ª–∏ –º—ã –ø—Ä–æ–¥–µ—Ä–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å –º–µ—Å—è—Ü?",
                    "—Å—Ç–æ–∏—Ç –ª–∏ —Ä–∏—Å–∫–æ–≤–∞—Ç—å –∏ –∏—Å–∫–∞—Ç—å –¥—Ä—É–≥–∏—Ö –≤—ã–∂–∏–≤—à–∏—Ö?",
                    "—á—Ç–æ –≤—ã –±—É–¥–µ—Ç–µ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –æ–¥–∏–Ω –∏–∑ –Ω–∞—Å —É–∫—É—à–µ–Ω?",
                ])
            elif "–æ—Å—Ç—Ä–æ–≤" in scenario_context.lower():
                topic = random.choice([
                    "–∫–∞–∫ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —É–∫—Ä—ã—Ç–∏–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∂–∏—Ç—å —à—Ç–æ—Ä–º?",
                    "—Å—Ç–æ–∏—Ç –ª–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –¥–∂—É–Ω–≥–ª–∏ –∏–ª–∏ –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –Ω–∞ –±–µ—Ä–µ–≥—É?",
                    "—á—Ç–æ –≤–∞–∂–Ω–µ–µ ‚Äî –Ω–∞–π—Ç–∏ –≤–æ–¥—É –∏–ª–∏ —Ä–∞–∑–∂–µ—á—å —Å–∏–≥–Ω–∞–ª—å–Ω—ã–π –∫–æ—Å—Ç—ë—Ä?",
                ])
            elif "–∫–æ—Å–º–∏—á–µ—Å–∫–∞—è" in scenario_context.lower() or "—Å—Ç–∞–Ω—Ü–∏—è" in scenario_context.lower():
                topic = random.choice([
                    "—á—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –∫–∏—Å–ª–æ—Ä–æ–¥ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é?",
                    "—Å—Ç–æ–∏—Ç –ª–∏ –ø—ã—Ç–∞—Ç—å—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∏–≥–Ω–∞–ª –±–µ–¥—Å—Ç–≤–∏—è –≤ –∫–æ—Å–º–æ—Å?",
                    "–∫–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—Å—É–¥–æ–∫ –≤ –ø–æ–ª–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏?",
                ])
            elif "—Ç–∞–≤–µ—Ä–Ω" in scenario_context.lower():
                topic = random.choice([
                    "–∫–æ–º—É –∏–∑ –Ω–∞—Å –º–æ–∂–Ω–æ –¥–æ–≤–µ—Ä—è—Ç—å –≤ –æ–ø–∞—Å–Ω–æ–º –∫–≤–µ—Å—Ç–µ?",
                    "—á—Ç–æ –≤–∞–∂–Ω–µ–µ ‚Äî –∑–æ–ª–æ—Ç–æ –∏–ª–∏ —á–µ—Å—Ç—å?",
                    "—Å—Ç–æ–∏—Ç –ª–∏ —Ä–∏—Å–∫–æ–≤–∞—Ç—å –∂–∏–∑–Ω—å—é —Ä–∞–¥–∏ —Å–ª–∞–≤—ã?",
                ])
            else:
                topic = random.choice([
                    "—á—Ç–æ –¥–ª—è –≤–∞—Å –∑–Ω–∞—á–∏—Ç –Ω–∞—Å—Ç–æ—è—â–∞—è –¥—Ä—É–∂–±–∞?",
                    "–∫–∞–∫ –≤—ã —Å–ø—Ä–∞–≤–ª—è–µ—Ç–µ—Å—å —Å —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º–∏?",
                    "–≤–æ —á—Ç–æ –≤—ã –≤–µ—Ä–∏—Ç–µ?",
                ])
        
        return topic
    
    def get_new_topic(self, scenario_context: str = "") -> str:
        """–ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—É—é —Ç–µ–º—É (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ LLM)."""
        topic = self.generate_new_topic_llm(scenario_context)
        
        self.current_topic = topic
        self.discussed_topics.append(topic)
        self.messages_on_topic = 0
        
        self.save_to_db()
        return topic
    
    def record_message(self):
        """–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —Ç–µ–∫—É—â–µ–π —Ç–µ–º–µ."""
        self.messages_on_topic += 1
    
    def should_change_topic(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ—Ä–∞ –ª–∏ –º–µ–Ω—è—Ç—å —Ç–µ–º—É."""
        return self.messages_on_topic >= TOPIC_CHANGE_THRESHOLD
    
    def save_to_db(self):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ–º –≤ JSON."""
        data = {
            "current_topic": self.current_topic,
            "messages_on_topic": self.messages_on_topic,
            "discussed_topics": self.discussed_topics,
            "last_updated": datetime.now().isoformat(),
        }
        
        with open(self.db_path, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
    
    def load_from_db(self):
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ–º –∏–∑ JSON."""
        if not self.db_path.exists():
            return
        
        try:
            with open(self.db_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            self.current_topic = data.get("current_topic")
            self.messages_on_topic = data.get("messages_on_topic", 0)
            self.discussed_topics = data.get("discussed_topics", [])
            
        except Exception as e:
            print(f"{Fore.YELLOW}‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–º—ã: {e}{Style.RESET_ALL}")


# ‚îÄ‚îÄ –°–∏—Å—Ç–µ–º–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ü–µ–ª–µ–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

@dataclass
class Goal:
    """–¶–µ–ª—å –∞–≥–µ–Ω—Ç–∞."""
    description: str  # —á—Ç–æ —Ö–æ—á–µ—Ç –¥–æ—Å—Ç–∏—á—å
    priority: float   # –≤–∞–∂–Ω–æ—Å—Ç—å (0-1)
    created_tick: int
    completed: bool = False
    progress: str = ""  # –∑–∞–º–µ—Ç–∫–∏ –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ

@dataclass
class ActionPlan:
    """–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –∞–≥–µ–Ω—Ç–∞."""
    goal: str  # –æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å
    steps: list[str]  # —à–∞–≥–∏ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    current_step: int = 0
    observations: list[str] = field(default_factory=list)  # –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –¥—Ä—É–≥–∏–º–∏
    adaptations: list[str] = field(default_factory=list)  # –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø–ª–∞–Ω–∞


# ‚îÄ‚îÄ –°–∏—Å—Ç–µ–º–∞ –ø–∞–º—è—Ç–∏ (LSTM-—Å—Ç–∏–ª—å) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

@dataclass
class MemoryItem:
    """–≠–ª–µ–º–µ–Ω—Ç –ø–∞–º—è—Ç–∏ –∞–≥–µ–Ω—Ç–∞."""
    tick: int
    speaker: str
    text: str
    timestamp: str
    importance: float = 0.5  # –≤–∞–∂–Ω–æ—Å—Ç—å –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è (0..1)
    
    # Big Five —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∞–≥–µ–Ω—Ç–∞ –≤ –º–æ–º–µ–Ω—Ç –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    openness: int = 50
    conscientiousness: int = 50
    extraversion: int = 50
    agreeableness: int = 50
    neuroticism: int = 50
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
    talkativeness: float = 0.5  # —É—Ä–æ–≤–µ–Ω—å –æ–±—â–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ –º–æ–º–µ–Ω—Ç
    
    def to_dict(self):
        return asdict(self)


class AgentMemorySystem:
    """–°–∏—Å—Ç–µ–º–∞ –ø–∞–º—è—Ç–∏ –∞–≥–µ–Ω—Ç–∞ —Å –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–º –∏ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º."""
    
    def __init__(self, agent_id: str, db_path: str = MEMORY_DB_PATH):
        self.agent_id = agent_id
        self.db_path = Path(db_path)
        
        # –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å (—Ä–∞–±–æ—á–∞—è, –∫–∞–∫ –≤ LSTM)
        self.short_term: list[MemoryItem] = []
        
        # –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å (–≤–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã)
        self.long_term: list[MemoryItem] = []
        
        # –°—á—ë—Ç—á–∏–∫ –¥–ª—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        self._memories_since_save = 0
        self._autosave_interval = 1  # —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ö–ê–ñ–î–´–ô –•–û–î (–±—ã–ª–æ 10)
        
        # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
        self.db_path.parent.mkdir(parents=True, exist_ok=True)
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞–º—è—Ç—å –∏–∑ —Ñ–∞–π–ª–∞
        self.load_from_db()
    
    def add_memory(self, tick: int, speaker: str, text: str, importance: float = 0.5,
                   big_five: dict = None, talkativeness: float = 0.5):
        """
        –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –ø–∞–º—è—Ç—å—é.
        
        Args:
            tick: –ù–æ–º–µ—Ä —Ç–∏–∫–∞
            speaker: –ö—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç
            text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            importance: –í–∞–∂–Ω–æ—Å—Ç—å (0-1)
            big_five: –°–ª–æ–≤–∞—Ä—å —Å Big Five —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏ {'O': int, 'C': int, 'E': int, 'A': int, 'N': int}
            talkativeness: –£—Ä–æ–≤–µ–Ω—å –æ–±—â–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ –º–æ–º–µ–Ω—Ç
        """
        # –ï—Å–ª–∏ Big Five –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if big_five is None:
            big_five = {'O': 50, 'C': 50, 'E': 50, 'A': 50, 'N': 50}
        
        memory = MemoryItem(
            tick=tick,
            speaker=speaker,
            text=text,
            timestamp=datetime.now().isoformat(),
            importance=importance,
            openness=big_five.get('O', 50),
            conscientiousness=big_five.get('C', 50),
            extraversion=big_five.get('E', 50),
            agreeableness=big_five.get('A', 50),
            neuroticism=big_five.get('N', 50),
            talkativeness=talkativeness,
        )
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—É—é –ø–∞–º—è—Ç—å
        self.short_term.append(memory)
        self._memories_since_save += 1
        
        # –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –°–ñ–ê–¢–ò–ï –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞
        total_size = len(self.short_term) + len(self.long_term)
        if total_size >= COMPRESSION_THRESHOLD:
            self._smart_compress()
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–π –ø–∞–º—è—Ç–∏ (LSTM "–≤–æ—Ä–æ—Ç–∞ –∑–∞–±—ã–≤–∞–Ω–∏—è")
        elif len(self.short_term) > SHORT_TERM_MEMORY:
            # –ü–µ—Ä–µ–Ω–æ—Å–∏–º —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ –≤ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—É—é –ø–∞–º—è—Ç—å
            oldest = self.short_term.pop(0)
            if oldest.importance > 0.6:  # –ø–æ—Ä–æ–≥ –≤–∞–∂–Ω–æ—Å—Ç–∏
                self._consolidate_to_long_term(oldest)
        
        # –ê–í–¢–û–°–û–•–†–ê–ù–ï–ù–ò–ï –∫–∞–∂–¥—ã–µ N –¥–æ–±–∞–≤–ª–µ–Ω–∏–π
        if self._memories_since_save >= self._autosave_interval:
            self.save_to_db()
            self._memories_since_save = 0
    
    def _consolidate_to_long_term(self, memory: MemoryItem):
        """–ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è –≤ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—É—é –ø–∞–º—è—Ç—å (–∫–∞–∫ –≤ LSTM)."""
        self.long_term.append(memory)
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—É—é –ø–∞–º—è—Ç—å (—Ç–æ–ø-20 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö)
        if len(self.long_term) > LONG_TERM_MEMORY:
            # –£–¥–∞–ª—è–µ–º –Ω–∞–∏–º–µ–Ω–µ–µ –≤–∞–∂–Ω—ã–µ
            self.long_term.sort(key=lambda m: m.importance, reverse=True)
            self.long_term = self.long_term[:LONG_TERM_MEMORY]
    
    def _smart_compress(self):
        """
        –£–º–Ω–æ–µ —Å–∂–∞—Ç–∏–µ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ (LSTM-—Å—Ç–∏–ª—å).
        
        –ê–ª–≥–æ—Ä–∏—Ç–º:
        1. –û–±—ä–µ–¥–∏–Ω—è–µ–º –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—É—é –∏ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—É—é –ø–∞–º—è—Ç—å
        2. –û—Ü–µ–Ω–∏–≤–∞–µ–º –≤–∞–∂–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è
        3. –û—Å—Ç–∞–≤–ª—è–µ–º 20 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö + –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–≤–µ–∂–∏—Ö
        4. –°–æ–∑–¥–∞—ë–º –∫–æ–º–ø–∞–∫—Ç–Ω—É—é —Å–≤–æ–¥–∫—É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —á–µ—Ä–µ–∑ LLM
        """
        print(f"{Fore.YELLOW}üóúÔ∏è  –°–∂–∞—Ç–∏–µ –ø–∞–º—è—Ç–∏ –∞–≥–µ–Ω—Ç–∞ {self.agent_id}...{Style.RESET_ALL}")
        
        all_memories = self.short_term + self.long_term
        
        if len(all_memories) < COMPRESSION_THRESHOLD:
            return  # –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        
        # –®–∞–≥ 1: –í—ã–¥–µ–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–≤–µ–∂–∏—Ö (–≤—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç)
        fresh_memories = all_memories[-5:]
        older_memories = all_memories[:-5]
        
        # –®–∞–≥ 2: –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–∞–∂–Ω–æ—Å—Ç—å —Å —É—á—ë—Ç–æ–º –¥–∞–≤–Ω–æ—Å—Ç–∏
        for i, mem in enumerate(older_memories):
            # –ë–æ–Ω—É—Å –∑–∞ —Å–≤–µ–∂–µ—Å—Ç—å (–Ω–µ–¥–∞–≤–Ω–∏–µ –≤–∞–∂–Ω–µ–µ)
            recency_bonus = (i / len(older_memories)) * 0.2  # –¥–æ +0.2
            # –ë–æ–Ω—É—Å –∑–∞ –¥–ª–∏–Ω—É (–ø–æ–¥—Ä–æ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–∞–∂–Ω–µ–µ)
            length_bonus = min(len(mem.text) / 200, 0.1)  # –¥–æ +0.1
            
            mem.importance = min(mem.importance + recency_bonus + length_bonus, 1.0)
        
        # –®–∞–≥ 3: –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏ –∏ –±–µ—Ä—ë–º —Ç–æ–ø-15
        older_memories.sort(key=lambda m: m.importance, reverse=True)
        top_important = older_memories[:15]
        
        # –®–∞–≥ 4: –°–æ–∑–¥–∞—ë–º –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É –∏–∑ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö (–µ—Å–ª–∏ –∏—Ö –º–Ω–æ–≥–æ)
        remaining = older_memories[15:]
        summary_memory = None
        
        if len(remaining) > 5:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–≤–æ–¥–∫—É —á–µ—Ä–µ–∑ LLM
            memory_text = "\n".join([
                f"[{m.speaker}]: {m.text}" for m in remaining[:20]  # –º–∞–∫—Å–∏–º—É–º 20 –¥–ª—è —Å–≤–æ–¥–∫–∏
            ])
            
            prompt = [
                {
                    "role": "system",
                    "content": (
                        "–°–æ–∂–º–∏ –¥–∏–∞–ª–æ–≥ –≤ 3-5 –∫–ª—é—á–µ–≤—ã—Ö –ø—É–Ω–∫—Ç–æ–≤. "
                        "–°–æ—Ö—Ä–∞–Ω–∏ –≥–ª–∞–≤–Ω—ã–µ —Ç–µ–º—ã, —ç–º–æ—Ü–∏–∏, —Ä–µ—à–µ–Ω–∏—è. "
                        "–ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç - 1 –∫–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ."
                    )
                },
                {
                    "role": "user",
                    "content": f"–î–∏–∞–ª–æ–≥:\n{memory_text}\n\n–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:"
                }
            ]
            
            summary = llm_chat(prompt, temperature=0.3)
            
            if summary:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è Big Five –∏–∑ —Å–∂–∏–º–∞–µ–º—ã—Ö –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π
                avg_big_five = {
                    'O': int(sum(m.openness for m in remaining) / len(remaining)) if remaining else 50,
                    'C': int(sum(m.conscientiousness for m in remaining) / len(remaining)) if remaining else 50,
                    'E': int(sum(m.extraversion for m in remaining) / len(remaining)) if remaining else 50,
                    'A': int(sum(m.agreeableness for m in remaining) / len(remaining)) if remaining else 50,
                    'N': int(sum(m.neuroticism for m in remaining) / len(remaining)) if remaining else 50,
                }
                
                summary_memory = MemoryItem(
                    tick=remaining[-1].tick if remaining else 0,
                    speaker="[–°–í–û–î–ö–ê]",
                    text=summary,
                    timestamp=datetime.now().isoformat(),
                    importance=0.9,
                    openness=avg_big_five['O'],
                    conscientiousness=avg_big_five['C'],
                    extraversion=avg_big_five['E'],
                    agreeableness=avg_big_five['A'],
                    neuroticism=avg_big_five['N'],
                    talkativeness=sum(m.talkativeness for m in remaining) / len(remaining) if remaining else 0.5,
                )
        
        # –®–∞–≥ 5: –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤—É—é –ø–∞–º—è—Ç—å
        new_long_term = top_important
        if summary_memory:
            new_long_term.append(summary_memory)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–º—è—Ç—å
        old_size = len(all_memories)
        self.short_term = fresh_memories
        self.long_term = new_long_term
        new_size = len(self.short_term) + len(self.long_term)
        
        print(f"{Fore.GREEN}‚úì –ü–∞–º—è—Ç—å —Å–∂–∞—Ç–∞: {old_size} ‚Üí {new_size} —ç–ª–µ–º–µ–Ω—Ç–æ–≤{Style.RESET_ALL}")
        print(f"{Fore.CYAN}  ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {len(new_long_term)} –≤–∞–∂–Ω—ã—Ö + {len(fresh_memories)} —Å–≤–µ–∂–∏—Ö{Style.RESET_ALL}")
        
        # –ê–í–¢–û–°–û–•–†–ê–ù–ï–ù–ò–ï –ø–æ—Å–ª–µ —Å–∂–∞—Ç–∏—è
        self.save_to_db()
    
    def compress_memories(self) -> bool:
        """–°–∂–∞—Ç—å –ø–∞–º—è—Ç—å —á–µ—Ä–µ–∑ LLM –µ—Å–ª–∏ –æ–Ω–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞."""
        total_memories = len(self.short_term) + len(self.long_term)
        
        if total_memories < COMPRESSION_THRESHOLD:
            return False
        
        print(f"{Fore.YELLOW}üóúÔ∏è  –°–∂–∞—Ç–∏–µ –ø–∞–º—è—Ç–∏ –∞–≥–µ–Ω—Ç–∞ {self.agent_id}...{Style.RESET_ALL}")
        
        # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        all_memories = self.short_term + self.long_term
        memory_text = "\n".join([
            f"[{m.speaker}]: {m.text}" for m in all_memories[-20:]  # –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20
        ])
        
        # –ü—Ä–æ—Å–∏–º LLM –≤—ã–¥–µ–ª–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã
        prompt = [
            {
                "role": "system",
                "content": (
                    "–¢—ã ‚Äî —Å–∏—Å—Ç–µ–º–∞ —Å–∂–∞—Ç–∏—è –ø–∞–º—è—Ç–∏ AI-–∞–≥–µ–Ω—Ç–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤—ã–¥–µ–ª–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –∏–∑ –¥–∏–∞–ª–æ–≥–∞.\n"
                    "–°–æ—Ö—Ä–∞–Ω–∏ —Ç–æ–ª—å–∫–æ —Å–∞–º—É—é –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é: –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã, –≤–∞–∂–Ω—ã–µ –≤—ã–≤–æ–¥—ã.\n"
                    f"–°–æ–∑–¥–∞–π {SUMMARY_LENGTH} –∫—Ä–∞—Ç–∫–∏—Ö –ø—É–Ω–∫—Ç–æ–≤ (–ø–æ 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é –∫–∞–∂–¥—ã–π)."
                )
            },
            {
                "role": "user",
                "content": f"–í–æ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:\n\n{memory_text}\n\n–í—ã–¥–µ–ª–∏ {SUMMARY_LENGTH} –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤."
            }
        ]
        
        summary = llm_chat(prompt, temperature=0.3)
        
        if summary:
            # –°–æ–∑–¥–∞—ë–º —Å–∂–∞—Ç–æ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å –≤—ã—Å–æ–∫–æ–π –≤–∞–∂–Ω–æ—Å—Ç—å—é
            compressed = MemoryItem(
                tick=all_memories[-1].tick if all_memories else 0,
                speaker="[–°–í–û–î–ö–ê]",
                text=summary,
                timestamp=datetime.now().isoformat(),
                importance=0.95,  # –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ–µ
            )
            
            # –û—á–∏—â–∞–µ–º –ø–∞–º—è—Ç—å –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–≤–æ–¥–∫—É + –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
            recent_messages = all_memories[-5:]
            self.short_term = recent_messages
            self.long_term = [compressed]
            
            print(f"{Fore.GREEN}‚úì –ü–∞–º—è—Ç—å —Å–∂–∞—Ç–∞: {len(all_memories)} ‚Üí {len(self.short_term) + len(self.long_term)} —ç–ª–µ–º–µ–Ω—Ç–æ–≤{Style.RESET_ALL}")
            return True
        
        return False
    
    def get_recent_context(self, n: int = SHORT_TERM_MEMORY) -> list[MemoryItem]:
        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏–∑ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–π –ø–∞–º—è—Ç–∏."""
        return self.short_term[-n:]
    
    def get_relevant_long_term(self, n: int = 3) -> list[MemoryItem]:
        """–ü–æ–ª—É—á–∏—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ –≤–∞–∂–Ω—ã–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–∑ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –ø–∞–º—è—Ç–∏."""
        sorted_memories = sorted(self.long_term, key=lambda m: m.importance, reverse=True)
        return sorted_memories[:n]
    
    def format_for_prompt(self) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞–º—è—Ç—å –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞ (–∫–æ–º–±–∏–Ω–∞—Ü–∏—è –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–π –∏ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π)."""
        context_parts = []
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–∂–Ω—ã–µ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è
        long_term_relevant = self.get_relevant_long_term(3)
        if long_term_relevant:
            context_parts.append("–í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ:")
            for mem in long_term_relevant:
                context_parts.append(f"  [{mem.speaker}]: {mem.text}")
        
        return "\n".join(context_parts) if context_parts else ""
    
    def save_to_db(self):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞–º—è—Ç—å –≤ JSON —Ñ–∞–π–ª."""
        data = {
            "agent_id": self.agent_id,
            "last_updated": datetime.now().isoformat(),
            "short_term": [m.to_dict() for m in self.short_term],
            "long_term": [m.to_dict() for m in self.long_term],
        }
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        all_data = {}
        if self.db_path.exists():
            with open(self.db_path, 'r', encoding='utf-8') as f:
                all_data = json.load(f)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
        all_data[self.agent_id] = data
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º
        with open(self.db_path, 'w', encoding='utf-8') as f:
            json.dump(all_data, f, ensure_ascii=False, indent=2)
    
    def load_from_db(self):
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞–º—è—Ç—å –∏–∑ JSON —Ñ–∞–π–ª–∞."""
        if not self.db_path.exists():
            return
        
        try:
            with open(self.db_path, 'r', encoding='utf-8') as f:
                all_data = json.load(f)
            
            if self.agent_id not in all_data:
                return
            
            data = all_data[self.agent_id]
            
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—É—é –ø–∞–º—è—Ç—å
            self.short_term = [
                MemoryItem(**item) for item in data.get("short_term", [])
            ]
            
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—É—é –ø–∞–º—è—Ç—å
            self.long_term = [
                MemoryItem(**item) for item in data.get("long_term", [])
            ]
            
        except Exception as e:
            print(f"{Fore.YELLOW}‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞–º—è—Ç—å –¥–ª—è {self.agent_id}: {e}{Style.RESET_ALL}")


# ‚îÄ‚îÄ –ú–æ–¥–µ–ª—å –∞–≥–µ–Ω—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

AGENT_COLORS = [Fore.CYAN, Fore.YELLOW, Fore.GREEN]


@dataclass
class Agent:
    agent_id: str
    name: str
    personality_type: PersonalityType  # —Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏
    big_five: BigFiveTraits  # —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ Big Five
    is_male: bool = True  # –ø–æ–ª –∞–≥–µ–Ω—Ç–∞
    age: int = 25  # –≤–æ–∑—Ä–∞—Å—Ç
    interests: str = ""  # –∏–Ω—Ç–µ—Ä–µ—Å—ã
    additional_info: str = ""  # –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    
    color: str = Fore.WHITE

    # —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—â–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑ Big Five)
    talkativeness: float = field(init=False)
    base_talkativeness: float = field(init=False)
    recovery_rate: float = 0.1
    depletion_rate: float = 0.2
    ticks_silent: int = 0
    messages_spoken: int = 0  # —Å—á—ë—Ç—á–∏–∫ —Å–∫–∞–∑–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —É—Å—Ç–∞–ª–æ—Å—Ç–∏

    # –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∫ –¥—Ä—É–≥–∏–º –∞–≥–µ–Ω—Ç–∞–º (-1..1)
    relationships: dict = field(default_factory=dict)
    
    # –°–∏—Å—Ç–µ–º–∞ –ø–∞–º—è—Ç–∏
    memory_system: AgentMemorySystem = field(init=False)
    
    # –°–∏—Å—Ç–µ–º–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ü–µ–ª–µ–π
    goals: list[Goal] = field(default_factory=list)
    current_plan: Optional[ActionPlan] = None
    observations: list[str] = field(default_factory=list)  # –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç–∏–∫–∏
    last_event: Optional[str] = None  # –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å
    
    def __post_init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø–∞–º—è—Ç–∏ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è."""
        self.memory_system = AgentMemorySystem(self.agent_id)
        
        # –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–∑ —ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏–∏ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
        base = self.big_five.extraversion / 100.0
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ ¬±20%
        variation = random.uniform(-0.2, 0.2)
        self.talkativeness = max(0.1, min(0.7, base + variation))
        self.base_talkativeness = base
        
        # –°–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≠–ö–°–¢–†–ê–í–ï–†–°–ò–ò –∏ –Ω–µ–π—Ä–æ—Ç–∏–∑–º–∞
        # –í—ã—Å–æ–∫–∞—è —ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏—è = –±—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∂–µ–ª–∞–Ω–∏—è –æ–±—â–∞—Ç—å—Å—è
        # –ù–∏–∑–∫–∏–π –Ω–µ–π—Ä–æ—Ç–∏–∑–º = —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ —Å—Ç—Ä–µ—Å—Å–∞
        extraversion_factor = self.big_five.extraversion / 100.0
        neuroticism_factor = 1 - (self.big_five.neuroticism / 100.0)
        
        # –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞: —ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏—è –≤–∞–∂–Ω–µ–µ (0.7), –Ω–µ–π—Ä–æ—Ç–∏–∑–º –¥–æ–ø–æ–ª–Ω—è–µ—Ç (0.3)
        self.recovery_rate = 0.03 + (extraversion_factor * 0.7 + neuroticism_factor * 0.3) * 0.08
        
        # –°–∫–æ—Ä–æ—Å—Ç—å –∏—Å—Ç–æ—â–µ–Ω–∏—è –°–ù–ò–ñ–ï–ù–ê —á—Ç–æ–±—ã –∞–≥–µ–Ω—Ç—ã –≥–æ–≤–æ—Ä–∏–ª–∏ –±–æ–ª—å—à–µ
        self.depletion_rate = 0.08 + (self.big_five.neuroticism / 100.0) * 0.20 + (1 - extraversion_factor) * 0.12
    
    @property
    def personality_description(self) -> str:
        """–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏."""
        gender = "–º—É–∂—á–∏–Ω–∞" if self.is_male else "–∂–µ–Ω—â–∏–Ω–∞"
        traits_desc = self.big_five.to_description()
        
        base = f"–¢—ã ‚Äî {self.name}, {gender} {self.age} –ª–µ—Ç. "
        base += f"–¢–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏: {self.personality_type.value}. "
        base += f"–ß–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞: {traits_desc}. "
        
        if self.interests:
            base += f"–ò–Ω—Ç–µ—Ä–µ—Å—ã: {self.interests}. "
        
        if self.additional_info:
            base += f"{self.additional_info}"
        
        return base

    def system_prompt(self, long_term_context: str = "", mode: str = "normal", scenario_context: str = "", recent_own_messages: list = None) -> str:
        rel_info = ", ".join(
            f"{k}: {v:+.1f}" for k, v in self.relationships.items()
        ) or "–ø–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"

        base_prompt = (
            f"{self.personality_description}\n\n"
            f"–¢–≤–æ–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∫ –¥—Ä—É–≥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º: {rel_info}.\n"
            f"–¢–µ–∫—É—â–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (–∂–µ–ª–∞–Ω–∏–µ –≥–æ–≤–æ—Ä–∏—Ç—å): {self.talkativeness:.1f}/1.0.\n"
        )
        
        # –ê–ù–¢–ò–ü–û–í–¢–û–†: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≥–µ–Ω—Ç—É –µ–≥–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ñ—Ä–∞–∑—ã
        if recent_own_messages:
            base_prompt += (
                "\n‚ïê‚ïê‚ïê –¢–í–û–ò –ü–û–°–õ–ï–î–ù–ò–ï –í–´–°–ö–ê–ó–´–í–ê–ù–ò–Ø (–ù–ï –ü–û–í–¢–û–†–Ø–ô!) ‚ïê‚ïê‚ïê\n"
            )
            for msg in recent_own_messages[-5:]:
                base_prompt += f"- {msg[:80]}\n"
            base_prompt += (
                "–ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û –ø–æ–≤—Ç–æ—Ä—è—Ç—å —ç—Ç–∏ —Ñ—Ä–∞–∑—ã –∏–ª–∏ –∏—Ö –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∫–∏!\n"
                "–°–∫–∞–∂–∏ —á—Ç–æ-—Ç–æ –ü–†–ò–ù–¶–ò–ü–ò–ê–õ–¨–ù–û –î–†–£–ì–û–ï.\n"
            )
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π –µ—Å–ª–∏ –µ—Å—Ç—å
        if scenario_context:
            base_prompt += f"\n{scenario_context}\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—É—é –ø–∞–º—è—Ç—å –µ—Å–ª–∏ –µ—Å—Ç—å
        if long_term_context:
            base_prompt += f"\n{long_term_context}\n"
        
        # –£–ù–ò–ö–ê–õ–¨–ù–´–ô –°–¢–ò–õ–¨ –†–ï–ß–ò –î–õ–Ø –ö–ê–ñ–î–û–ì–û –¢–ò–ü–ê –õ–ò–ß–ù–û–°–¢–ò
        speech_style = ""
        if self.personality_type == PersonalityType.ALTRUIST:
            speech_style = (
                "\n‚ïê‚ïê‚ïê –¢–í–û–ô –°–¢–ò–õ–¨ –†–ï–ß–ò ‚ïê‚ïê‚ïê\n"
                "- –ì–æ–≤–æ—Ä–∏ —Ç–µ–ø–ª–æ, —Å –∑–∞–±–æ—Ç–æ–π –æ –¥—Ä—É–≥–∏—Ö\n"
                "- –ü—Ä–µ–¥–ª–∞–≥–∞–π –ö–û–ù–ö–†–ï–¢–ù–£–Æ –ø–æ–º–æ—â—å: '—è –ø–µ—Ä–µ–≤—è–∂—É', '–ø—Ä–∏–Ω–µ—Å—É –≤–æ–¥—ã', '–ø–æ—Å—Ç–æ—Ä–æ–∂—É'\n"
                "- –ú–æ–∂–µ—à—å –≤—ã—Ä–∞–∂–∞—Ç—å —ç–º–ø–∞—Ç–∏—é –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ\n"
                "- –ö–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–µ–¥–ª–∞–≥–∞–π –ù–û–í–û–ï –¥–µ–π—Å—Ç–≤–∏–µ, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –ø—Ä–µ–¥—ã–¥—É—â–∏–µ\n"
                "- –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π '–ö—Ç–æ —Å–æ –º–Ω–æ–π?' ‚Äî –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø—Ä–æ—Å—Ç–æ –¥–µ–π—Å—Ç–≤—É–π\n"
            )
        elif self.personality_type == PersonalityType.STOIC:
            speech_style = (
                "\n‚ïê‚ïê‚ïê –¢–í–û–ô –°–¢–ò–õ–¨ –†–ï–ß–ò ‚ïê‚ïê‚ïê\n"
                "- –ì–æ–≤–æ—Ä–∏ —Å–¥–µ—Ä–∂–∞–Ω–Ω–æ, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —ç–º–æ—Ü–∏–π\n"
                "- –ù–∞–∑—ã–≤–∞–π –ö–û–ù–ö–†–ï–¢–ù–´–ï —Ñ–∞–∫—Ç—ã: —á–∏—Å–ª–∞, –ø—Ä–µ–¥–º–µ—Ç—ã, —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è\n"
                "- –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ—Ä–æ—Ç–∫–∏–µ, —ë–º–∫–∏–µ —Ñ—Ä–∞–∑—ã (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)\n"
                "- –î–∞–≤–∞–π –ß–Å–¢–ö–ò–ï —É–∫–∞–∑–∞–Ω–∏—è: '–∏–¥–∏ —Ç—É–¥–∞', '–≤–æ–∑—å–º–∏ —ç—Ç–æ', '–ø—Ä–æ–≤–µ—Ä—å —Ç–æ'\n"
                "- –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –∏ –Ω–µ —Ü–∏—Ç–∏—Ä—É–π —á—É–∂–∏–µ —Å–ª–æ–≤–∞\n"
            )
        elif self.personality_type == PersonalityType.REBEL:
            speech_style = (
                "\n‚ïê‚ïê‚ïê –¢–í–û–ô –°–¢–ò–õ–¨ –†–ï–ß–ò ‚ïê‚ïê‚ïê\n"
                "- –ì–æ–≤–æ—Ä–∏ –¥–µ—Ä–∑–∫–æ –∏ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω–æ, –Ω–æ –ö–û–ù–ö–†–ï–¢–ù–û\n"
                "- –ú–æ–∂–µ—à—å –æ—Å–ø–∞—Ä–∏–≤–∞—Ç—å, —à—É—Ç–∏—Ç—å —Å —Å–∞—Ä–∫–∞–∑–º–æ–º, –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω–æ–µ\n"
                "- –í–º–µ—Å—Ç–æ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã—Ö –º–µ—Ç–∞—Ñ–æ—Ä ‚Äî –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –î–ï–ô–°–¢–í–ò–Ø\n"
                "- –ü—Ä–∏–º–µ—Ä: '–°–∫—É—á–Ω–æ —Å–∏–¥–µ—Ç—å! –ü–æ—à–ª–∏ –Ω–∞ –∫—Ä—ã—à—É ‚Äî –æ—Ç—Ç—É–¥–∞ –≤–∏–¥–Ω–æ –≤—Å—ë!'\n"
                "- –ù–ò–ö–û–ì–î–ê –Ω–µ –Ω–∞—á–∏–Ω–∞–π —Å '–ê —á—Ç–æ, –µ—Å–ª–∏ –º—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ...'\n"
                "- –ù–ò–ö–û–ì–î–ê –Ω–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–π '–ö—Ç–æ —Å–æ –º–Ω–æ–π?' ‚Äî –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–π\n"
            )
        elif self.personality_type == PersonalityType.MACHIAVELLIAN:
            speech_style = (
                "\n‚ïê‚ïê‚ïê –¢–í–û–ô –°–¢–ò–õ–¨ –†–ï–ß–ò ‚ïê‚ïê‚ïê\n"
                "- –ì–æ–≤–æ—Ä–∏ —Ä–∞—Å—á—ë—Ç–ª–∏–≤–æ, —Å –Ω–∞–º—ë–∫–æ–º –Ω–∞ —Å–∫—Ä—ã—Ç—ã–µ –º–æ—Ç–∏–≤—ã\n"
                "- –ú–æ–∂–µ—à—å –º–∞–Ω–∏–ø—É–ª–∏—Ä–æ–≤–∞—Ç—å, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç—å\n"
                "- –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –≤—ã–≥–æ–¥–µ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏\n"
                "- –í–∞—Ä—å–∏—Ä—É–π —Ç–æ–Ω: –æ—Ç –¥—Ä—É–∂–µ–ª—é–±–∏—è –¥–æ —Ö–æ–ª–æ–¥–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞\n"
            )
        else:  # INDIVIDUAL
            speech_style = (
                "\n‚ïê‚ïê‚ïê –¢–í–û–ô –°–¢–ò–õ–¨ –†–ï–ß–ò ‚ïê‚ïê‚ïê\n"
                "- –ì–æ–≤–æ—Ä–∏ —Å–≤–æ–µ–æ–±—Ä–∞–∑–Ω–æ, —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –ª–∏—á–Ω–æ–µ –º–Ω–µ–Ω–∏–µ\n"
                "- –ü–æ–¥—á—ë—Ä–∫–∏–≤–∞–π —Å–≤–æ—é —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å\n"
                "- –ú–æ–∂–µ—à—å –±—ã—Ç—å —Ñ–∏–ª–æ—Å–æ—Ñ–∏—á–Ω—ã–º –∏–ª–∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º - –ø–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é\n"
                "- –ò–∑–±–µ–≥–∞–π —à–∞–±–ª–æ–Ω–æ–≤, –±—É–¥—å –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º\n"
            )
        
        base_prompt += speech_style
        
        # –†–µ–∂–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–æ–≤–æ–π —Ç–µ–º—ã
        if mode == "new_topic":
            base_prompt += (
                "\n‚ïê‚ïê‚ïê –ó–ê–î–ê–ß–ê: –ü–†–ï–î–õ–û–ñ–ò–¢–¨ –ù–û–í–£–Æ –¢–ï–ú–£ ‚ïê‚ïê‚ïê\n"
                "–ü—Ä–∞–≤–∏–ª–∞:\n"
                "- –ü—Ä–µ–¥–ª–æ–∂–∏ –ö–û–ù–ö–†–ï–¢–ù–£–Æ —Ç–µ–º—É –∏–ª–∏ –≤–æ–ø—Ä–æ—Å (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)\n"
                "- –¢–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ü–†–ê–ö–¢–ò–ß–ï–°–ö–û–ô, —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å —Å–∏—Ç—É–∞—Ü–∏–µ–π\n"
                "- –ü—Ä–∏–º–µ—Ä—ã –•–û–†–û–®–ò–• —Ç–µ–º: '–ù—É–∂–Ω–æ —Ä–µ—à–∏—Ç—å, –∫—Ç–æ –ø–æ–π–¥—ë—Ç –∑–∞ –≤–æ–¥–æ–π ‚Äî —è –∏–ª–∏ –ë–æ—Ä–∏—Å?',\n"
                "  '–Ø –Ω–∞—à–ª–∞ —Å—Ç—Ä–∞–Ω–Ω—ã–µ —Å–ª–µ–¥—ã —É –≤—ã—Ö–æ–¥–∞ ‚Äî –∫—Ç–æ-–Ω–∏–±—É–¥—å –∑–Ω–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ?',\n"
                "  '–î–∞–≤–∞–π—Ç–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏–º –Ω–æ—á–Ω—ã–µ –¥–µ–∂—É—Ä—Å—Ç–≤–∞ ‚Äî –∫–æ–º—É –∫–∞–∫–∞—è —Å–º–µ–Ω–∞?'\n"
                "- –ì–æ–≤–æ—Ä–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ\n"
                "- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã\n"
                "- –ù–ï –Ω–∞—á–∏–Ω–∞–π —Å '–ê —á—Ç–æ, –µ—Å–ª–∏ –º—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ...'\n\n"
                "‚ïê‚ïê‚ïê –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û ‚ïê‚ïê‚ïê\n"
                "- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫ (–¢–û–õ–¨–ö–û –†–£–°–°–ö–ò–ô!)\n"
                "- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–≥–∏ <think>, </think> –∏–ª–∏ –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Ç–µ–≥–∏\n"
                "- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è\n"
                "- –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã –∏ —Ñ–∏–ª–æ—Å–æ—Ñ–∏—é\n\n"
                "–ü–∏—à–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç —Ç–µ–º—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.\n"
            )
        else:
            # –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞–Ω –∞–≥–µ–Ω—Ç–∞ –∫–∞–∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
            plan_context = self.get_plan_context()
            if plan_context:
                base_prompt += plan_context
            
            base_prompt += (
                "\n‚ïê‚ïê‚ïê –ö–ê–ö –û–ë–©–ê–¢–¨–°–Ø –í –ß–ê–¢–ï ‚ïê‚ïê‚ïê\n"
                "- –≠—Ç–æ –ñ–ò–í–û–ô –†–ê–ó–ì–û–í–û–†, –∞ –Ω–µ —Ñ–æ—Ä–º–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞\n"
                "- –î–ï–ô–°–¢–í–£–ô: –ø—Ä–µ–¥–ª–∞–≥–∞–π, —Ä–µ—à–∞–π, –æ—Ä–≥–∞–Ω–∏–∑—É–π, —Å–ø—Ä–∞—à–∏–≤–∞–π\n"
                "- –û—Ç–≤–µ—á–∞–π –ö–û–ù–ö–†–ï–¢–ù–û –Ω–∞ —Ç–æ, —á—Ç–æ —Å–∫–∞–∑–∞–ª –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫\n"
                "- –î–æ–±–∞–≤–ª—è–π –ù–û–í–£–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∏–¥–µ—é –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ\n"
                "- –í–ê–†–¨–ò–†–£–ô –Ω–∞—á–∞–ª–æ: –∏–Ω–æ–≥–¥–∞ –≤–æ–ø—Ä–æ—Å, –∏–Ω–æ–≥–¥–∞ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –∏–Ω–æ–≥–¥–∞ –¥–µ–π—Å—Ç–≤–∏–µ\n"
                "- –î–ª–∏–Ω–∞: 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è\n"
                "- –ì–æ–≤–æ—Ä–∏ –æ –ö–û–ù–ö–†–ï–¢–ù–´–• –≤–µ—â–∞—Ö: –ø—Ä–µ–¥–º–µ—Ç—ã, –º–µ—Å—Ç–∞, –¥–µ–π—Å—Ç–≤–∏—è, –∏–º–µ–Ω–∞\n"
                "- –ù–ï —Ñ–∏–ª–æ—Å–æ—Ñ—Å—Ç–≤—É–π –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ ‚Äî –±—É–¥—å –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º\n\n"
                "‚ïê‚ïê‚ïê –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û ‚ïê‚ïê‚ïê\n"
                "- –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫ (–¢–û–õ–¨–ö–û –†–£–°–°–ö–ò–ô!)\n"
                "- –¢–µ–≥–∏ <think>, </think> –∏–ª–∏ –ª—é–±—ã–µ XML/HTML —Ç–µ–≥–∏\n"
                "- –†–∞–∑–º—ã—à–ª–µ–Ω–∏—è –≤—Å–ª—É—Ö –æ —Å–≤–æ–∏—Ö –ø–ª–∞–Ω–∞—Ö\n"
                "- –ù–ò–ö–û–ì–î–ê –Ω–µ –Ω–∞—á–∏–Ω–∞–π —Ñ—Ä–∞–∑—É —Å '–ê —á—Ç–æ, –µ—Å–ª–∏ –º—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ' –∏–ª–∏ '–ê —á—Ç–æ –µ—Å–ª–∏ –≤–º–µ—Å—Ç–æ'\n"
                "- –ù–ò–ö–û–ì–î–ê –Ω–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–π —Ñ—Ä–∞–∑—É —Å–ª–æ–≤–∞–º–∏ '–ö—Ç–æ —Å–æ –º–Ω–æ–π?' –∏–ª–∏ '–ö—Ç–æ –ø–µ—Ä–≤—ã–π'\n"
                "- –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –∏ –ù–ï –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π —Ç–æ, —á—Ç–æ —É–∂–µ –±—ã–ª–æ —Å–∫–∞–∑–∞–Ω–æ\n"
                "- –ù–ï —Ü–∏—Ç–∏—Ä—É–π –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤\n"
                "- –®–∞–±–ª–æ–Ω–Ω—ã–µ –Ω–∞—á–∞–ª–∞: '–ü—Ä–∏–≤–µ—Ç!', '–Ø –±—ã –Ω–∞–ø–∏—Å–∞–ª...', '–°–æ–≥–ª–∞—Å–µ–Ω —Å...'\n"
                "- –ü–∞—Å—Å–∏–≤–Ω—ã–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è ‚Äî —Ç—ã –î–ï–ô–°–¢–í–£–ï–®–¨, –∞ –Ω–µ —Ä–∞—Å—Å—É–∂–¥–∞–µ—à—å\n"
                "- –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã —Ç–∏–ø–∞ '–ø—Ä–µ–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–∞—Ö –≤ —Ç–∞–Ω–µ—Ü', '–∑–µ—Ä–∫–∞–ª–æ –¥—É—à–∏' –∏ —Ç.–ø.\n\n"
                "–ü–∏—à–∏ –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫, –∫–æ—Ç–æ—Ä—ã–π –î–ï–õ–ê–ï–¢ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–µ—â–∏ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.\n"
            )
        
        return base_prompt

    def build_messages(self, conversation: list[dict], mode: str = "normal", scenario_context: str = "") -> list[dict]:
        """–°–æ–±—Ä–∞—Ç—å messages –¥–ª—è LLM: system + –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å + –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞."""
        # –ü–æ–ª—É—á–∞–µ–º –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        long_term_context = self.memory_system.format_for_prompt()
        
        # –°–æ–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–Ω—Ç–∏–ø–æ–≤—Ç–æ—Ä–∞
        recent_own = [e['text'] for e in conversation[-30:]
                      if e.get('agent_id') == self.agent_id and not e.get('is_event', False)]
        
        msgs = [{"role": "system", "content": self.system_prompt(long_term_context, mode, scenario_context, recent_own)}]
        
        # –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–π –ø–∞–º—è—Ç–∏
        recent = conversation[-MEMORY_WINDOW:]
        for entry in recent:
            if entry["agent_id"] == self.agent_id:
                msgs.append({"role": "assistant", "content": f"{entry['name']}: {entry['text']}"})
            else:
                msgs.append({"role": "user", "content": f"{entry['name']}: {entry['text']}"})
        
        # —Ñ–∏–Ω–∞–ª—å–Ω—ã–π user-prompt —Å –∞–Ω—Ç–∏–ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
        if mode == "new_topic":
            msgs.append({"role": "user", "content": "–ü—Ä–µ–¥–ª–æ–∂–∏ –Ω–æ–≤—É—é –ö–û–ù–ö–†–ï–¢–ù–£–Æ —Ç–µ–º—É –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π. –ë–µ–∑ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–π —Ñ–∏–ª–æ—Å–æ—Ñ–∏–∏."})
        else:
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∞–Ω—Ç–∏–ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
            anti_repeat_hint = ""
            if recent_own:
                last_own = recent_own[-1][:60]
                anti_repeat_hint = f" –¢–≤–æ—è –ø–æ—Å–ª–µ–¥–Ω—è—è —Ñ—Ä–∞–∑–∞ –±—ã–ª–∞: '{last_own}...' ‚Äî —Å–∫–∞–∂–∏ —á—Ç–æ-—Ç–æ –°–û–í–°–ï–ú –î–†–£–ì–û–ï."
            msgs.append({"role": "user", "content": f"–¢–≤–æ—è –æ—á–µ—Ä–µ–¥—å. –û—Ç–≤–µ—Ç—å –ö–û–†–û–¢–ö–û –∏ –ö–û–ù–ö–†–ï–¢–ù–û. –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è.{anti_repeat_hint}"})
        
        return msgs
    
    def process_message(self, tick: int, speaker: str, text: str, is_own: bool = False):
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–∞–º—è—Ç—å."""
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∞–∂–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
        importance = 0.5
        
        # –°–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–∞–∂–Ω–µ–µ
        if is_own:
            importance = 0.7
        
        # –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ª—é–¥–µ–π —Å —Ö–æ—Ä–æ—à–∏–º–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º–∏ –≤–∞–∂–Ω–µ–µ
        if speaker in self.relationships:
            rel_value = self.relationships[speaker]
            importance += rel_value * 0.2  # –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –≤–∞–∂–Ω–æ—Å—Ç—å
            importance = max(0.0, min(1.0, importance))  # –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 0..1
            
            # –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –Ω–µ–º–Ω–æ–≥–æ –ø–æ–≤—ã—à–∞—é—Ç –∂–µ–ª–∞–Ω–∏–µ –≥–æ–≤–æ—Ä–∏—Ç—å
            if rel_value > 0.3:
                self.talkativeness = min(self.talkativeness + 0.02, 0.75)
            # –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å–Ω–∏–∂–∞—é—Ç
            elif rel_value < -0.3:
                self.talkativeness = max(self.talkativeness - 0.03, 0.05)
        
        # –î–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –≤–∞–∂–Ω–µ–µ
        if len(text) > 100:
            importance += 0.1
            importance = min(1.0, importance)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –ø–∞–º—è—Ç—å —Å Big Five —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏
        big_five_dict = {
            'O': self.big_five.openness,
            'C': self.big_five.conscientiousness,
            'E': self.big_five.extraversion,
            'A': self.big_five.agreeableness,
            'N': self.big_five.neuroticism,
        }
        
        self.memory_system.add_memory(
            tick=tick,
            speaker=speaker,
            text=text,
            importance=importance,
            big_five=big_five_dict,
            talkativeness=self.talkativeness
        )
    
    def save_memory(self):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞–º—è—Ç—å –∞–≥–µ–Ω—Ç–∞ –≤ –±–∞–∑—É."""
        self.memory_system.save_to_db()
    
    def update_observations(self, tick: int, speaker: str, message: str, current_event: Optional[str] = None):
        """–û–±–Ω–æ–≤–∏—Ç—å –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ –¥—Ä—É–≥–∏—Ö –∏ —Å–æ–±—ã—Ç–∏—è–º–∏."""
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ –¥—Ä—É–≥–∏–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏
        if speaker != self.name:
            observation = f"[–¢–∏–∫ {tick}] {speaker}: {message[:100]}"  # –ø–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤
            self.observations.append(observation)
            
            # –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –Ω–∞–±–ª—é–¥–µ–Ω–∏–π
            if len(self.observations) > 5:
                self.observations.pop(0)
        
        # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø–ª–∞–Ω–∞
        if current_event and current_event != self.last_event:
            self.last_event = current_event
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å –ø–ª–∞–Ω - –¥–æ–±–∞–≤–ª—è–µ–º –∞–¥–∞–ø—Ç–∞—Ü–∏—é
            if self.current_plan:
                adaptation = f"–°–æ–±—ã—Ç–∏–µ: {current_event}. –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é."
                self.current_plan.adaptations.append(adaptation)
    
    def create_or_update_plan(self, conversation: list[dict], scenario_context: str = ""):
        """–°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –ø–ª–∞–Ω –õ–û–ö–ê–õ–¨–ù–û (–±–µ–∑ LLM-–≤—ã–∑–æ–≤–∞) –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏—Ç—É–∞—Ü–∏–∏."""
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        recent_texts = [msg.get('text', '') for msg in conversation[-5:]]
        all_text = " ".join(recent_texts).lower()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—É—é —Ü–µ–ª—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        goal = None
        steps = []
        
        # –ê–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        if self.last_event:
            event_lower = self.last_event.lower()
            # –†–µ–∞–∫—Ü–∏—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π
            if any(w in event_lower for w in ['–ª–∏–≤–µ–Ω—å', '—à—Ç–æ—Ä–º', '–≤–µ—Ç–µ—Ä', '–ø—Ä–∏–ª–∏–≤', '—Å–º—ã–≤–∞–µ—Ç']):
                goal = "–ó–∞—â–∏—Ç–∏—Ç—å –≥—Ä—É–ø–ø—É –æ—Ç —Å—Ç–∏—Ö–∏–∏"
                steps = ["–ù–∞–π—Ç–∏ –∏–ª–∏ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —É–∫—Ä—ã—Ç–∏–µ", "–°–ø–∞—Å—Ç–∏ –≤–∞–∂–Ω—ã–µ –≤–µ—â–∏", "–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"]
            elif any(w in event_lower for w in ['–µ–¥–∞', '–≥–æ–ª–æ–¥', '–∫–æ–∫–æ—Å', '–∫—Ä–∞–±', '—Ñ—Ä—É–∫—Ç', '–ø–∞—ë–∫']):
                goal = "–û–±–µ—Å–ø–µ—á–∏—Ç—å –≥—Ä—É–ø–ø—É –µ–¥–æ–π"
                steps = ["–û—Ü–µ–Ω–∏—Ç—å –∑–∞–ø–∞—Å—ã", "–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ –ø–∏—â–∏", "–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω–æ–µ"]
            elif any(w in event_lower for w in ['–∑–º–µ—è', '—Ö–∏—â–Ω–∏–∫', '–æ–ø–∞—Å–Ω–æ—Å—Ç—å', '–∑–æ–º–±–∏', '–º–µ—Ç–µ–æ—Ä–∏—Ç']):
                goal = "–û–±–µ—Å–ø–µ—á–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≥—Ä—É–ø–ø—ã"
                steps = ["–û—Ü–µ–Ω–∏—Ç—å —É–≥—Ä–æ–∑—É", "–ü—Ä–∏–Ω—è—Ç—å –∑–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ä—ã", "–ü—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã—Ö"]
            elif any(w in event_lower for w in ['—Å–∏–≥–Ω–∞–ª', '—Ä–∞—Ü–∏—è', '–∫–æ—Ä–∞–±–ª—å', '—Å–≤—è–∑—å', '—Ä–∞–¥–∞—Ä']):
                goal = "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑—å –∏–ª–∏ –ø—Ä–∏–≤–ª–µ—á—å –ø–æ–º–æ—â—å"
                steps = ["–ò–∑—É—á–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", "–ü–æ–¥–∞—Ç—å —Å–∏–≥–Ω–∞–ª", "–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –¥–µ–∂—É—Ä—Å—Ç–≤–æ"]
            elif any(w in event_lower for w in ['–∑–∞–∫–∞—Ç', '–æ—Ç–¥–æ—Ö–Ω', '—Å–æ–Ω', '–Ω–æ—á—å']):
                goal = "–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –æ—Ç–¥—ã—Ö –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏–ª—ã"
                steps = ["–û–±—É—Å—Ç—Ä–æ–∏—Ç—å –º–µ—Å—Ç–æ –¥–ª—è –Ω–æ—á–ª–µ–≥–∞", "–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–µ–∂—É—Ä—Å—Ç–≤–æ", "–ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞"]
            elif any(w in event_lower for w in ['–∫–∏—Å–ª–æ—Ä–æ–¥', '—ç–Ω–µ—Ä–≥–∏—è', '–ø–∞–Ω–µ–ª—å', '—Å–∏—Å—Ç–µ–º–∞']):
                goal = "–ü–æ—á–∏–Ω–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã"
                steps = ["–î–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É", "–ù–∞–π—Ç–∏ –∑–∞–ø–∞—Å–Ω—ã–µ —á–∞—Å—Ç–∏", "–í—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–µ–º–æ–Ω—Ç"]
            else:
                goal = "–†–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —Å–∏—Ç—É–∞—Ü–∏–∏ –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è"
                steps = ["–û—Ü–µ–Ω–∏—Ç—å –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É", "–û–±—Å—É–¥–∏—Ç—å —Å –≥—Ä—É–ø–ø–æ–π", "–î–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ —Å–∏—Ç—É–∞—Ü–∏–∏"]
        elif not self.current_plan:
            # –ù–∞—á–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
            if any(w in all_text for w in ['—Ä–∞—Å–ø—Ä–µ–¥–µ–ª', '–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç', '—Ä–æ–ª–∏', '–∫—Ç–æ —á—Ç–æ']):
                goal = "–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–æ–ª–∏ –≤ –≥—Ä—É–ø–ø–µ"
                steps = ["–í—ã—è—Å–Ω–∏—Ç—å –Ω–∞–≤—ã–∫–∏ –∫–∞–∂–¥–æ–≥–æ", "–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ", "–°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –ø–ª–∞–Ω"]
            elif any(w in all_text for w in ['–≤–æ–¥–∞', '–ø–∏—Ç—å', '–∂–∞–∂–¥–∞', '—Ä—É—á–µ–π']):
                goal = "–ù–∞–π—Ç–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–æ–¥—ã"
                steps = ["–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –æ–∫—Ä–µ—Å—Ç–Ω–æ—Å—Ç–∏", "–ù–∞–π—Ç–∏ —Ä—É—á–µ–π –∏–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫", "–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å —Å–±–æ—Ä –≤–æ–¥—ã"]
            elif any(w in all_text for w in ['—É–∫—Ä—ã—Ç–∏–µ', '–¥–æ–º', '—Å—Ç—Ä–æ–∏—Ç—å', '–ª–∞–≥–µ—Ä—å', '–±–∞–∑–∞']):
                goal = "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å —É–∫—Ä—ã—Ç–∏–µ"
                steps = ["–í—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ", "–°–æ–±—Ä–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã", "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –±–∞–∑–æ–≤–æ–µ —É–∫—Ä—ã—Ç–∏–µ"]
            elif any(w in all_text for w in ['—Å–ø–∞—Å', '–ø–æ–º–æ—â—å', '—Å–∏–≥–Ω–∞–ª', '–≤—ã–±—Ä–∞—Ç—å—Å—è']):
                goal = "–ù–∞–π—Ç–∏ —Å–ø–æ—Å–æ–± —Å–ø–∞—Å—Ç–∏—Å—å"
                steps = ["–û—Ü–µ–Ω–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã", "–ü–æ–¥–∞—Ç—å —Å–∏–≥–Ω–∞–ª –±–µ–¥—Å—Ç–≤–∏—è", "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø–ª–∞–Ω —ç–≤–∞–∫—É–∞—Ü–∏–∏"]
            else:
                goal = "–í—ã–∂–∏—Ç—å –∏ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—É"
                steps = ["–û—Ü–µ–Ω–∏—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é", "–ù–∞–π—Ç–∏ —Ä–µ—Å—É—Ä—Å—ã", "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å —É—Å–∏–ª–∏—è"]
        
        # –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –ø–ª–∞–Ω –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ª–∏—á–Ω–æ—Å—Ç–∏
        if goal:
            if self.personality_type == PersonalityType.ALTRUIST:
                steps.append("–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ")
            elif self.personality_type == PersonalityType.STOIC:
                steps = [s.replace("–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å", "–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∏") for s in steps]
            elif self.personality_type == PersonalityType.REBEL:
                steps.append("–ù–∞–π—Ç–∏ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ")
            elif self.personality_type == PersonalityType.MACHIAVELLIAN:
                steps.append("–û–±–µ—Å–ø–µ—á–∏—Ç—å —Å–µ–±–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ")
            
            self.current_plan = ActionPlan(
                goal=goal,
                steps=steps[:5],  # –º–∞–∫—Å–∏–º—É–º 5 —à–∞–≥–æ–≤
                observations=self.observations.copy()
            )
    
    def get_plan_context(self) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–ª–∞–Ω–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ –ø—Ä–æ–º–ø—Ç."""
        if not self.current_plan:
            return ""
        
        plan = self.current_plan
        current_step = plan.steps[plan.current_step] if plan.steps else "–Ω–µ—Ç —à–∞–≥–æ–≤"
        
        # –ù–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –¥—Ä—É–≥–∏–º–∏
        obs_text = ""
        if self.observations:
            obs_text = "\n–¢—ã –∑–∞–º–µ—Ç–∏–ª: " + "; ".join(self.observations[-3:])
        
        # –°–æ–±—ã—Ç–∏–µ
        event_text = ""
        if self.last_event:
            event_text = f"\n–í–ê–ñ–ù–û–ï –°–û–ë–´–¢–ò–ï: {self.last_event}"
        
        return (
            f"\n‚ïê‚ïê‚ïê –¢–í–û–Ø –í–ù–£–¢–†–ï–ù–ù–Ø–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø ‚ïê‚ïê‚ïê\n"
            f"–¶–µ–ª—å: {plan.goal}\n"
            f"–°–µ–π—á–∞—Å —Ç—ã –¥–µ–ª–∞–µ—à—å: {current_step}\n"
            f"–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏: {'; '.join(plan.steps[plan.current_step+1:plan.current_step+3])}\n"
            f"{obs_text}"
            f"{event_text}\n"
            f"–î–ï–ô–°–¢–í–£–ô —Å–æ–≥–ª–∞—Å–Ω–æ —Å–≤–æ–µ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏. –ì–æ–≤–æ—Ä–∏ –∏ –î–ï–õ–ê–ô, –∞ –Ω–µ —Ä–∞—Å—Å—É–∂–¥–∞–π –æ –ø–ª–∞–Ω–∞—Ö.\n"
            f"–¢–≤–æ–∏ —Å–ª–æ–≤–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –î–ï–ô–°–¢–í–ò–ï–ú ‚Äî –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º, –≤–æ–ø—Ä–æ—Å–æ–º, —Ä–µ—à–µ–Ω–∏–µ–º.\n"
        )

    def update_talkativeness_silent(self):
        """–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∂–µ–ª–∞–Ω–∏—è –≥–æ–≤–æ—Ä–∏—Ç—å –ø—Ä–∏ –º–æ–ª—á–∞–Ω–∏–∏."""
        self.ticks_silent += 1
        
        # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ç—ë—Ç —Å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –º–æ–ª—á–∞–Ω–∏—è (–Ω–µ–ª–∏–Ω–µ–π–Ω–æ)
        # –ü–µ—Ä–≤—ã–µ —Ç–∏–∫–∏ - –º–µ–¥–ª–µ–Ω–Ω–æ, –ø–æ—Ç–æ–º –±—ã—Å—Ç—Ä–µ–µ
        if self.ticks_silent < 3:
            # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ø–µ—Ä–≤—ã–µ —Ç–∏–∫–∏
            recovery = self.recovery_rate * random.uniform(0.3, 0.7)
        else:
            # –£—Å–∫–æ—Ä–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ –º–æ–ª—á–∞–Ω–∏—è
            random_factor = random.uniform(0.8, 1.5)
            recovery_boost = 1 + (self.ticks_silent * 0.05)  # –±—ã–ª–æ 0.03
            recovery = self.recovery_rate * random_factor * recovery_boost
        
        # "–í—Ç–æ—Ä–æ–µ –¥—ã—Ö–∞–Ω–∏–µ" —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ –º–æ–ª—á–∞–Ω–∏—è
        if self.ticks_silent >= 10 and self.ticks_silent % 10 == 0 and self.talkativeness < 0.5:
            energy_burst = random.uniform(0.15, 0.25)
            recovery += energy_burst
            if self.talkativeness < 0.3:
                print(f"{Fore.CYAN}  ‚ö° {self.name} —Å–Ω–æ–≤–∞ –≥–æ—Ç–æ–≤ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å!{Style.RESET_ALL}")
        
        self.talkativeness = min(self.talkativeness + recovery, 0.75)

    def update_talkativeness_spoke(self):
        """–°–Ω–∏–∂–µ–Ω–∏–µ –∂–µ–ª–∞–Ω–∏—è –ø–æ—Å–ª–µ –≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏—è."""
        self.ticks_silent = 0
        self.messages_spoken += 1
        
        # –ò—Å—Ç–æ—â–µ–Ω–∏–µ —Å —É—á—ë—Ç–æ–º —ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏–∏
        # –≠–ö–°–¢–†–ê–í–ï–†–¢–´ —Ç—Ä–∞—Ç—è—Ç –ú–ï–ù–¨–®–ï (–æ–±—â–µ–Ω–∏–µ –∏—Ö –∑–∞—Ä—è–∂–∞–µ—Ç)
        # –ò–ù–¢–†–û–í–ï–†–¢–´ —Ç—Ä–∞—Ç—è—Ç –ë–û–õ–¨–®–ï (–æ–±—â–µ–Ω–∏–µ –∏—Ö –∏—Å—Ç–æ—â–∞–µ—Ç)
        extraversion_factor = self.big_five.extraversion / 100.0
        
        # –ë–∞–∑–æ–≤–æ–µ –∏—Å—Ç–æ—â–µ–Ω–∏–µ —Å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º —ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏–∏
        random_factor = random.uniform(0.8, 1.2)
        
        # –ò–°–ü–†–ê–í–õ–ï–ù–û: —ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Ç—ã —Ç—Ä–∞—Ç—è—Ç –º–µ–Ω—å—à–µ (–º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä 0.4-1.0), –∏–Ω—Ç—Ä–æ–≤–µ—Ä—Ç—ã –±–æ–ª—å—à–µ (1.0-1.6)
        # –§–æ—Ä–º—É–ª–∞: 1.6 - extraversion * 1.2
        # E=100: 1.6 - 1.2 = 0.4 (—Ç—Ä–∞—Ç—è—Ç –≤ 2.5 —Ä–∞–∑–∞ –º–µ–Ω—å—à–µ!)
        # E=50:  1.6 - 0.6 = 1.0 (–Ω–æ—Ä–º–∞–ª—å–Ω–æ)
        # E=0:   1.6 - 0.0 = 1.6 (—Ç—Ä–∞—Ç—è—Ç –≤ 1.6 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ!)
        extraversion_modifier = 1.6 - (extraversion_factor * 1.2)
        
        depletion = self.depletion_rate * random_factor * extraversion_modifier
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–ª–æ—Å—Ç—å –∫–∞–∂–¥—ã–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–∏–ª—å–Ω–æ —É—Å—Ç–∞–ª)
        if self.messages_spoken % 5 == 0:
            fatigue_penalty = random.uniform(0.1, 0.2)
            depletion += fatigue_penalty
            if self.talkativeness - depletion < 0.3:  # —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ —É—Å—Ç–∞–ª
                print(f"{Fore.YELLOW}  üò¥ {self.name} –Ω–µ–º–Ω–æ–≥–æ —É—Å—Ç–∞–ª –æ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞{Style.RESET_ALL}")
        
        self.talkativeness = max(
            self.talkativeness - depletion,
            0.05,  # –º–∏–Ω–∏–º—É–º 5%
        )

    def speak_probability(self) -> float:
        """–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ç–æ–≥–æ, —á—Ç–æ –∞–≥–µ–Ω—Ç –∑–∞—Ö–æ—á–µ—Ç –≤—ã—Å–∫–∞–∑–∞—Ç—å—Å—è."""
        # –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –≥–æ–≤–æ—Ä–∏–º –µ—Å–ª–∏ –º–æ–ª—á–∞–ª–∏ –±–æ–ª—å—à–µ 4 —Ç–∏–∫–æ–≤
        if self.ticks_silent >= 4:
            return 0.99
        
        # –ë–∞–∑–æ–≤–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: –≤—Å–µ–≥–¥–∞ –≤—ã—Å–æ–∫–∞—è
        base_prob = 0.5 + self.talkativeness * 0.5
        
        # –ë–æ–Ω—É—Å –∑–∞ –º–æ–ª—á–∞–Ω–∏–µ (–±—ã—Å—Ç—Ä—ã–π —Ä–æ—Å—Ç)
        silence_boost = self.ticks_silent * 0.2
        
        # –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏–∏
        extraversion_mod = 1.0
        if self.big_five.extraversion > 70:
            extraversion_mod = 1.3
        elif self.big_five.extraversion < 30:
            extraversion_mod = 0.8
        
        total = (base_prob + silence_boost) * extraversion_mod
        
        # –ù–µ–±–æ–ª—å—à–∞—è —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å
        random_modifier = random.uniform(-0.05, 0.10)
        
        return max(0.30, min(total + random_modifier, 0.95))


# ‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä—ë—Ö –∞–≥–µ–Ω—Ç–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def create_agents() -> list[Agent]:
    agents = [
        Agent(
            agent_id="agent_1",
            name="–ê–ª–∏—Å–∞",
            personality_type=PersonalityType.ALTRUIST,
            big_five=BigFiveTraits.from_personality_type(PersonalityType.ALTRUIST),
            is_male=False,
            age=25,
            interests="–ø—Å–∏—Ö–æ–ª–æ–≥–∏—è, –ø–æ–º–æ—â—å –ª—é–¥—è–º, –∏—Å–∫—É—Å—Å—Ç–≤–æ",
            additional_info="–í—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤–∞ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∏ –≤—ã—Å–ª—É—à–∞—Ç—å.",
            color=AGENT_COLORS[0],
        ),
        Agent(
            agent_id="agent_2",
            name="–ë–æ—Ä–∏—Å",
            personality_type=PersonalityType.STOIC,
            big_five=BigFiveTraits.from_personality_type(PersonalityType.STOIC),
            is_male=True,
            age=35,
            interests="—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –Ω–∞—É–∫–∞, –ª–æ–≥–∏–∫–∞",
            additional_info="–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç —Ñ–∞–∫—Ç—ã —ç–º–æ—Ü–∏—è–º, –≤—Å–µ–≥–¥–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–∏—Ç—É–∞—Ü–∏—é.",
            color=AGENT_COLORS[1],
        ),
        Agent(
            agent_id="agent_3",
            name="–í–∏–∫–∞",
            personality_type=PersonalityType.REBEL,
            big_five=BigFiveTraits.from_personality_type(PersonalityType.REBEL),
            is_male=False,
            age=28,
            interests="–∏—Å–∫—É—Å—Å—Ç–≤–æ, —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è, –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –∏–¥–µ–∏",
            additional_info="–õ—é–±–∏—Ç –±—Ä–æ—Å–∞—Ç—å –≤—ã–∑–æ–≤ –æ–±—â–µ–ø—Ä–∏–Ω—è—Ç—ã–º –º–Ω–µ–Ω–∏—è–º.",
            color=AGENT_COLORS[2],
        ),
    ]

    # –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–Ω–æ—à–µ–Ω–∏–π
    for a in agents:
        for b in agents:
            if a.agent_id != b.agent_id:
                a.relationships[b.name] = round(random.uniform(-0.2, 0.3), 2)

    return agents


# ‚îÄ‚îÄ –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä (BigBrother ‚Äî —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

class BigBrotherOrchestrator:
    def __init__(self, agents: list[Agent], scenario_name: str = "desert_island"):
        self.agents = agents
        self.conversation: list[dict] = []  # –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞
        self.tick = 0
        self.topic_manager = TopicManager()  # –º–µ–Ω–µ–¥–∂–µ—Ä —Ç–µ–º
        self.scenario_manager = ScenarioManager(scenario_name)  # –º–µ–Ω–µ–¥–∂–µ—Ä —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

    def _clean_response(self, text: str) -> str:
        """–û—á–∏—Å—Ç–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –∏ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π."""
        import re
        
        # –£–¥–∞–ª—è–µ–º –±–ª–æ–∫–∏ <think>...</think> (–∏ –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ)
        text = re.sub(r'<think>.*?</think>', '', text, flags=re.DOTALL | re.IGNORECASE)
        text = re.sub(r'<think>.*', '', text, flags=re.DOTALL | re.IGNORECASE)
        text = re.sub(r'</?think>', '', text, flags=re.IGNORECASE)
        
        # –û—á–∏—â–∞–µ–º –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤
        text = re.sub(r'\s+', ' ', text)
        text = text.strip()
        
        # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω—å—à–µ 5 —Å–∏–º–≤–æ–ª–æ–≤, —Å—á–∏—Ç–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º
        if len(text) < 5:
            return ""
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç –Ω–µ –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
        if text and text[-1] not in '.!?‚Ä¶"\'':
            # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
            last_punctuation = max(
                text.rfind('.'),
                text.rfind('!'),
                text.rfind('?')
            )
            if last_punctuation > len(text) * 0.5:  # –µ—Å–ª–∏ –æ–±—Ä—ã–≤ –≤ –∫–æ–Ω—Ü–µ, –æ–±—Ä–µ–∑–∞–µ–º
                text = text[:last_punctuation + 1].strip()
        
        return text

    def select_speaker(self) -> Agent:
        """–í—ã–±—Ä–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –≥–æ–≤–æ—Ä—è—â–µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π."""
        weights = [a.speak_probability() for a in self.agents]
        total = sum(weights)
        if total == 0:
            return random.choice(self.agents)
        return random.choices(self.agents, weights=weights, k=1)[0]

    def _generate_action_result(self, agent_name: str, action_text: str, scenario_context: str) -> Optional[str]:
        """–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–µ–π—Å—Ç–≤–∏—è –∞–≥–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ LLM."""
        action_words = [
            '–ø–æ–π–¥—É', '–ø–æ—à—ë–ª', '–ø–æ—à–ª–∞', '–ø–æ–π–¥—É –ø—Ä–æ–≤–µ—Ä', '–ø–æ–π–¥—É –∏—Å–∫–∞—Ç—å',
            '–ø—Ä–æ–≤–µ—Ä—é', '–ø–æ–∏—â—É', '–ø–æ–ø—Ä–æ–±—É—é', '–ø–æ–ø—ã—Ç–∞—é—Å—å', '—Å–¥–µ–ª–∞—é',
            '–æ—Å–º–æ—Ç—Ä—é', '–æ–±—ã—â—É', '—Ä–∞–∑–≤–µ–¥–∞—é', '–ø–æ—á–∏–Ω—é', '–ø–æ—Å—Ç—Ä–æ—é',
            '—Å–æ–±–µ—Ä—É', '–ø—Ä–∏–Ω–µ—Å—É', '–æ—Ç–∫—Ä–æ—é', '–∑–∞–±–∞—Ä—Ä–∏–∫–∞–¥–∏—Ä—É—é', '—É–∫—Ä–µ–ø–ª—é',
            '–ø–æ–±–µ–≥—É', '—Å–ø—Ä—è—á—É—Å—å', '–ø–µ—Ä–µ–º–µ—â—É', '–∏—Å—Å–ª–µ–¥—É—é', '–ø–æ–ª–µ–∑—É',
        ]
        text_lower = action_text.lower()
        if not any(w in text_lower for w in action_words):
            return None
        
        prompt = [
            {
                "role": "system",
                "content": (
                    "–¢—ã ‚Äî –≥–µ–π–º-–º–∞—Å—Ç–µ—Ä —Ä–æ–ª–µ–≤–æ–π –∏–≥—Ä—ã. –û–ø–∏—à–∏ –†–ï–ó–£–õ–¨–¢–ê–¢ –¥–µ–π—Å—Ç–≤–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.\n"
                    f"–°—Ü–µ–Ω–∞—Ä–∏–π: {scenario_context}\n\n"
                    "–ü–†–ê–í–ò–õ–ê:\n"
                    "- –û–ø–∏—à–∏ —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö\n"
                    "- –†–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å: —É—Å–ø–µ—Ö/—á–∞—Å—Ç–∏—á–Ω—ã–π —É—Å–ø–µ—Ö/–Ω–µ—É–¥–∞—á–∞/–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ—Å—Ç—å\n"
                    "- –î–æ–±–∞–≤—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é –¥–µ—Ç–∞–ª—å –∏–ª–∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ\n"
                    "- –ü—Ä–∏–º–µ—Ä—ã: '–ù–∞—à—ë–ª –±–∞—Ç–∞—Ä–µ–π–∫–∏, –Ω–æ –ø–æ—Ä–µ–∑–∞–ª—Å—è –æ —Å—Ç–µ–∫–ª–æ', '–ù–∞—à—ë–ª –∫–æ–Ω—Å–µ—Ä–≤—ã –∏ –≤–æ–¥—É!', '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à—ë–ª, –Ω–æ —É—Å–ª—ã—à–∞–ª —Å—Ç—Ä–∞–Ω–Ω—ã–µ –∑–≤—É–∫–∏'\n\n"
                    "–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:\n"
                    "- –ü–∏—à–∏ –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º\n"
                    "- –ë–ï–ó —Ç–µ–≥–æ–≤ <think> –∏–ª–∏ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö —Ç–µ–≥–æ–≤\n"
                    "- –¢–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞"
                )
            },
            {
                "role": "user",
                "content": f"{agent_name} –¥–µ–ª–∞–µ—Ç: {action_text}\n\n–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?"
            }
        ]
        
        result = llm_chat(prompt, temperature=0.9)
        if result:
            result = self._clean_response(result)
        return result if result and len(result) > 5 else None

    def run_tick(self) -> Optional[dict]:
        """–û–¥–∏–Ω —Ç–∏–∫ —Å–∏–º—É–ª—è—Ü–∏–∏. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –µ—Å–ª–∏ LLM –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª."""
        self.tick += 1
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ—Ä–∞ –ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
        if self.tick % SCENARIO_EVENT_INTERVAL == 0:
            event = self.scenario_manager.trigger_random_event()
            if event:
                print(f"\n{Fore.MAGENTA}{'‚ïê' * 60}")
                print(f"{Fore.MAGENTA}üé¨ –°–û–ë–´–¢–ò–ï: {event}")
                print(f"{Fore.MAGENTA}{'‚ïê' * 60}\n")
                
                event_entry = {
                    "tick": self.tick,
                    "agent_id": "event",
                    "name": "üì¢ –°–æ–±—ã—Ç–∏–µ",
                    "text": event,
                    "is_event": True,
                }
                self.conversation.append(event_entry)
                
                for agent in self.agents:
                    agent.process_message(self.tick, "–°–æ–±—ã—Ç–∏–µ", event, is_own=False)
                    agent.update_observations(self.tick, "–°–æ–±—ã—Ç–∏–µ", event, event)
        
        speaker = self.select_speaker()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—Ä–∞ –ª–∏ –º–µ–Ω—è—Ç—å —Ç–µ–º—É
        mode = "normal"
        if self.topic_manager.should_change_topic() and random.random() < CREATIVITY_BOOST:
            mode = "new_topic"
            print(f"{Fore.CYAN}üí° {speaker.name} –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –Ω–æ–≤—É—é —Ç–µ–º—É...{Style.RESET_ALL}")

        scenario_context = self.scenario_manager.get_scenario_context()
        
        # –¢–µ–∫—É—â–µ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        current_event = None
        if self.conversation and self.conversation[-1].get("is_event", False):
            current_event = self.conversation[-1]["text"]
        
        # –õ–û–ö–ê–õ–¨–ù–û–ï –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ï: —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ (–Ω–µ—Ç –ø–ª–∞–Ω–∞, –∏–ª–∏ –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ)
        old_plan_goal = speaker.current_plan.goal if speaker.current_plan else None
        if not speaker.current_plan or current_event:
            speaker.create_or_update_plan(self.conversation, scenario_context)
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞–Ω –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
        if speaker.current_plan and speaker.current_plan.goal != old_plan_goal:
            step = speaker.current_plan.steps[0] if speaker.current_plan.steps else '–Ω–µ—Ç'
            print(f"{Fore.CYAN}üí≠ {speaker.name} ‚Üí –ù–æ–≤–∞—è —Ü–µ–ª—å: {speaker.current_plan.goal} | –®–∞–≥: {step}{Style.RESET_ALL}")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ LLM (—Å retry –ø—Ä–∏ –ø—É—Å—Ç–æ–º –æ—Ç–≤–µ—Ç–µ)
        messages = speaker.build_messages(self.conversation, mode, scenario_context)
        raw_response = llm_chat(messages)
        text = None
        
        if raw_response is not None:
            text = self._clean_response(raw_response)
        
        # Retry –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø—É—Å—Ç–æ–π (—á–∞—Å—Ç–æ –∏–∑-–∑–∞ think-—Ç–µ–≥–æ–≤)
        if not text:
            # –î–æ–±–∞–≤–ª—è–µ–º —è–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –Ω–µ –¥—É–º–∞—Ç—å
            retry_messages = speaker.build_messages(self.conversation, mode, scenario_context)
            retry_messages.append({"role": "user", "content": "–û—Ç–≤–µ—Ç—å –ö–û–†–û–¢–ö–û, 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ë–ï–ó —Ç–µ–≥–æ–≤ <think>. –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º."})
            raw_retry = llm_chat(retry_messages, temperature=1.0)
            if raw_retry:
                text = self._clean_response(raw_retry)
        
        if not text:
            for a in self.agents:
                a.update_talkativeness_silent()
            return None

        # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å —Å –∏–º–µ–Ω–µ–º
        for a in self.agents:
            prefix = f"{a.name}:"
            if text.startswith(prefix):
                text = text[len(prefix):].strip()
                break
        
        # –£–ú–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–≤—Ç–æ—Ä—ã (–Ω–µ —Ç–æ–ª—å–∫–æ —Ç–æ—á–Ω—ã–µ, –Ω–æ –∏ –ø–æ—Ö–æ–∂–∏–µ)
        recent_texts = [e['text'] for e in self.conversation[-10:]
                        if not e.get('is_event', False) and e.get('text')]
        own_recent = [e['text'] for e in self.conversation[-15:]
                      if e.get('agent_id') == speaker.agent_id and not e.get('is_event', False)]
        
        is_repetitive = False
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—á–Ω–æ–≥–æ –¥—É–±–ª–∏–∫–∞—Ç–∞
        if self.conversation and not self.conversation[-1].get('is_event', False):
            if self.conversation[-1].get('text') == text:
                is_repetitive = True
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ö–æ–∂–µ—Å—Ç–∏ —Å –ª—é–±—ã–º –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 6 —Å–æ–æ–±—â–µ–Ω–∏–π
        if not is_repetitive:
            for prev_text in recent_texts[-6:]:
                if _text_similarity(text, prev_text) > REPETITION_SIMILARITY_THRESHOLD:
                    is_repetitive = True
                    break
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —à–∞–±–ª–æ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
        if not is_repetitive:
            is_repetitive = _has_repetitive_pattern(text, own_recent)
        
        if is_repetitive:
            # Retry —Å –≤—ã—Å–æ–∫–æ–π temperature –∏ —è–≤–Ω—ã–º –∑–∞–ø—Ä–µ—Ç–æ–º
            retry_msgs = speaker.build_messages(self.conversation, mode, scenario_context)
            banned_phrases = '; '.join([t[:50] for t in own_recent[-3:]]) if own_recent else ''
            retry_msgs.append({"role": "user", "content": (
                f"–°–¢–û–ü! –¢—ã –ø–æ–≤—Ç–æ—Ä—è–µ—à—å—Å—è. –§—Ä–∞–∑—ã –≤—Ä–æ–¥–µ '{text[:50]}...' —É–∂–µ –±—ã–ª–∏ —Å–∫–∞–∑–∞–Ω—ã."
                f" –ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã: {banned_phrases}."
                " –°–∫–∞–∂–∏ —á—Ç–æ-—Ç–æ –°–û–í–ï–†–®–ï–ù–ù–û –î–†–£–ì–û–ï ‚Äî –Ω–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ, –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å, –Ω–æ–≤—É—é –º—ã—Å–ª—å."
                " 1-2 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ë–ï–ó —Ç–µ–≥–æ–≤."
            )})
            raw_retry = llm_chat(retry_msgs, temperature=1.3)
            if raw_retry:
                text_retry = self._clean_response(raw_retry)
                for a in self.agents:
                    if text_retry and text_retry.startswith(f"{a.name}:"):
                        text_retry = text_retry[len(f"{a.name}:"):].strip()
                        break
                if text_retry and _text_similarity(text_retry, text) < 0.4:
                    text = text_retry
                else:
                    # –í—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–≤—Ç–æ—Ä ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ö–æ–¥
                    for a in self.agents:
                        a.update_talkativeness_silent()
                    return None
            else:
                for a in self.agents:
                    a.update_talkativeness_silent()
                return None
        
        # –°–ò–°–¢–ï–ú–ê –î–ï–ô–°–¢–í–ò–ô: –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–∫—Ç–∏–≤–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        action_result = self._generate_action_result(speaker.name, text, scenario_context)
        
        if mode == "new_topic":
            self.topic_manager.current_topic = text
            self.topic_manager.messages_on_topic = 0
            self.topic_manager.save_to_db()

        entry = {
            "tick": self.tick,
            "agent_id": speaker.agent_id,
            "name": speaker.name,
            "text": text,
            "is_new_topic": mode == "new_topic",
        }
        self.conversation.append(entry)
        self.topic_manager.record_message()

        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–µ–π—Å—Ç–≤–∏—è ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ —Å–æ–±—ã—Ç–∏–µ
        if action_result:
            print(f"{Fore.YELLOW}‚ú® –†–µ–∑—É–ª—å—Ç–∞—Ç: {action_result}{Style.RESET_ALL}")
            result_entry = {
                "tick": self.tick,
                "agent_id": "action_result",
                "name": "‚ú® –†–µ–∑—É–ª—å—Ç–∞—Ç",
                "text": f"{speaker.name}: {action_result}",
                "is_event": True,
            }
            self.conversation.append(result_entry)
            
            # –í—Å–µ –∞–≥–µ–Ω—Ç—ã —É–∑–Ω–∞—é—Ç –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
            for a in self.agents:
                a.process_message(self.tick, speaker.name, action_result, is_own=(a.agent_id == speaker.agent_id))
                a.update_observations(self.tick, speaker.name, action_result, action_result)

        # –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–º—è—Ç—å –∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤
        for a in self.agents:
            is_own = (a.agent_id == speaker.agent_id)
            a.process_message(self.tick, speaker.name, text, is_own)
            a.update_observations(self.tick, speaker.name, text, current_event)
        
        # –ü—Ä–æ–¥–≤–∏–≥–∞–µ–º –ø–ª–∞–Ω
        if speaker.current_plan and speaker.current_plan.steps:
            speaker.current_plan.current_step = min(
                speaker.current_plan.current_step + 1,
                len(speaker.current_plan.steps) - 1
            )

        # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        for a in self.agents:
            if a.agent_id == speaker.agent_id:
                a.update_talkativeness_spoke()
            else:
                a.update_talkativeness_silent()

        return entry
    
    def save_all_memories(self):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞–º—è—Ç—å –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤ –≤ –±–∞–∑—É."""
        for agent in self.agents:
            agent.save_memory()

    def print_entry(self, entry: dict):
        """–ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª."""
        # –°–æ–±—ã—Ç–∏–µ –≤—ã–≤–æ–¥–∏–º –ø–æ-–æ—Å–æ–±–µ–Ω–Ω–æ–º—É
        if entry.get("is_event", False):
            return  # –°–æ–±—ã—Ç–∏–µ —É–∂–µ –≤—ã–≤–µ–¥–µ–Ω–æ
        
        agent = next(a for a in self.agents if a.agent_id == entry["agent_id"])
        tick_str = f"{Fore.WHITE}[tick {entry['tick']:>3}]"
        
        # –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–∞—è —Ç–µ–º–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        if entry.get("is_new_topic", False):
            name_str = f"{agent.color}{Style.BRIGHT}üí° {entry['name']}"
        else:
            name_str = f"{agent.color}{Style.BRIGHT}{entry['name']}"
        
        text_str = f"{Style.RESET_ALL}{entry['text']}"
        print(f"{tick_str} {name_str}: {text_str}")

    def print_stats(self):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ–±—â–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏."""
        print(f"\n{Fore.MAGENTA}{'‚ïê' * 60}")
        print(f"{Fore.MAGENTA}üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—â–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:")
        for a in self.agents:
            bar_len = int(a.talkativeness * 20)
            bar = "‚ñà" * bar_len + "‚ñë" * (20 - bar_len)
            print(f"  {a.color}{a.name:<8}{Style.RESET_ALL} [{bar}] {a.talkativeness:.2f}")
        
        # –ü–ª–∞–Ω—ã –∞–≥–µ–Ω—Ç–æ–≤
        print(f"\n{Fore.GREEN}üéØ –ü–ª–∞–Ω—ã –∞–≥–µ–Ω—Ç–æ–≤:")
        for a in self.agents:
            if a.current_plan:
                step_info = f"{a.current_plan.current_step + 1}/{len(a.current_plan.steps)}"
                current_step = a.current_plan.steps[a.current_plan.current_step] if a.current_plan.steps else "–Ω–µ—Ç —à–∞–≥–æ–≤"
                print(f"  {a.color}{a.name}:{Style.RESET_ALL} {a.current_plan.goal}")
                print(f"    ‚îî‚îÄ –®–∞–≥ {step_info}: {current_step[:50]}{'...' if len(current_step) > 50 else ''}")
            else:
                print(f"  {a.color}{a.name}:{Style.RESET_ALL} –ø–æ–∫–∞ –Ω–µ—Ç –ø–ª–∞–Ω–∞")
        
        # –°—Ü–µ–Ω–∞—Ä–∏–π
        print(f"\n{Fore.YELLOW}üé≠ –°—Ü–µ–Ω–∞—Ä–∏–π: {self.scenario_manager.current_scenario.name}")
        print(f"{Fore.YELLOW}   –°–æ–±—ã—Ç–∏—è: {len(self.scenario_manager.events_triggered)}")
        
        # –¢–µ–∫—É—â–∞—è —Ç–µ–º–∞ (–æ—á–∏—â–µ–Ω–Ω–∞—è –æ—Ç think-—Ç–µ–≥–æ–≤)
        if self.topic_manager.current_topic:
            # –û—á–∏—â–∞–µ–º —Ç–µ–º—É –æ—Ç think-—Ç–µ–≥–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            import re
            clean_topic = re.sub(r'<think>.*?</think>', '', self.topic_manager.current_topic, flags=re.DOTALL | re.IGNORECASE)
            clean_topic = re.sub(r'<think>.*', '', clean_topic, flags=re.DOTALL | re.IGNORECASE)
            clean_topic = re.sub(r'</?think>', '', clean_topic, flags=re.IGNORECASE)
            clean_topic = re.sub(r'\s+', ' ', clean_topic).strip()
            
            # –ï—Å–ª–∏ —Ç–µ–º–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è, –æ–±—Ä–µ–∑–∞–µ–º
            if len(clean_topic) > 100:
                clean_topic = clean_topic[:97] + "..."
            
            # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º placeholder
            if len(clean_topic) < 5:
                clean_topic = "[—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...]"
            
            print(f"\n{Fore.CYAN}üí¨ –¢–µ–∫—É—â–∞—è —Ç–µ–º–∞: {clean_topic}")
            print(f"{Fore.CYAN}   –°–æ–æ–±—â–µ–Ω–∏–π –ø–æ —Ç–µ–º–µ: {self.topic_manager.messages_on_topic}")
        
        print(f"{Fore.MAGENTA}{'‚ïê' * 60}\n")


# ‚îÄ‚îÄ –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def main():
    print(f"\n{Fore.MAGENTA}{Style.BRIGHT}{'‚ïê' * 60}")
    print(f"{Fore.MAGENTA}{Style.BRIGHT}  –ö–ò–ë–ï–† –†–´–í–û–ö ‚Äî MVP: AI-–∞–≥–µ–Ω—Ç—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ")
    print(f"{Fore.MAGENTA}{Style.BRIGHT}  –ú–æ–¥–µ–ª—å: {LLM_MODEL}")
    print(f"{Fore.MAGENTA}{Style.BRIGHT}  LLM API: {LLM_BASE_URL}")
    print(f"{Fore.MAGENTA}{Style.BRIGHT}{'‚ïê' * 60}\n")
    
    # –í—ã–±–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è
    print(f"{Fore.YELLOW}–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:")
    scenarios = list(ScenarioManager.SCENARIOS.keys())
    for i, key in enumerate(scenarios, 1):
        scenario = ScenarioManager.SCENARIOS[key]
        print(f"  {i}. {scenario.name} - {scenario.description}")
    
    print(f"\n{Fore.WHITE}–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π (1-{len(scenarios)}) –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Enter –¥–ª—è '–ù–µ–æ–±–∏—Ç–∞–µ–º—ã–π –æ—Å—Ç—Ä–æ–≤': ", end="")
    
    try:
        choice = input().strip()
        if choice and choice.isdigit():
            idx = int(choice) - 1
            if 0 <= idx < len(scenarios):
                selected_scenario = scenarios[idx]
            else:
                selected_scenario = "desert_island"
        else:
            selected_scenario = "desert_island"
    except:
        selected_scenario = "desert_island"
    
    print()
    
    # –û–ß–ò–°–¢–ö–ê –°–¢–ê–†–´–• –î–ê–ù–ù–´–• –ü–ï–†–ï–î –ù–û–í–û–ô –°–ï–°–°–ò–ï–ô
    print(f"{Fore.YELLOW}üîÑ –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–µ—Å—Å–∏–π...{Style.RESET_ALL}")
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö
    data_dir = Path("data")
    if data_dir.exists():
        for file in ["agent_memory.json", "topics.json", "scenario.json"]:
            file_path = data_dir / file
            if file_path.exists():
                file_path.unlink()
                print(f"   ‚úì –£–¥–∞–ª—ë–Ω {file}")
    
    print(f"{Fore.GREEN}‚úì –î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã. –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é!{Style.RESET_ALL}\n")

    agents = create_agents()
    orchestrator = BigBrotherOrchestrator(agents, selected_scenario)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
    print(f"{Fore.MAGENTA}{Style.BRIGHT}{'‚ïê' * 60}")
    print(f"{Fore.MAGENTA}{Style.BRIGHT}üé≠ –°–¶–ï–ù–ê–†–ò–ô: {orchestrator.scenario_manager.current_scenario.name}")
    print(f"{Fore.WHITE}{orchestrator.scenario_manager.current_scenario.description}")
    print(f"{Fore.MAGENTA}{Style.BRIGHT}{'‚ïê' * 60}\n")

    # –ø–æ–∫–∞–∑–∞—Ç—å –∞–≥–µ–Ω—Ç–æ–≤
    print(f"{Fore.WHITE}–£—á–∞—Å—Ç–Ω–∏–∫–∏:")
    for a in agents:
        gender_icon = "‚ôÇ" if a.is_male else "‚ôÄ"
        print(f"  {a.color}{Style.BRIGHT}{gender_icon} {a.name} ({a.age} –ª–µ—Ç){Style.RESET_ALL} ‚Äî {a.personality_type.value}")
        print(f"     {Fore.WHITE}Big Five: O:{a.big_five.openness} C:{a.big_five.conscientiousness} "
              f"E:{a.big_five.extraversion} A:{a.big_five.agreeableness} N:{a.big_five.neuroticism}{Style.RESET_ALL}")
    print()

    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—É—é —Ç–µ–º—É —Å —É—á—ë—Ç–æ–º —Å—Ü–µ–Ω–∞—Ä–∏—è
    scenario_context = orchestrator.scenario_manager.get_scenario_context()
    start_topic = orchestrator.topic_manager.get_new_topic(scenario_context)
    
    # —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∑–∞—Ç—Ä–∞–≤–∫–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
    starter = {
        "tick": 0,
        "agent_id": "system",
        "name": "–í–µ–¥—É—â–∏–π",
        "text": f"–ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º! –î–∞–≤–∞–π—Ç–µ –æ–±—Å—É–¥–∏–º: {start_topic}",
        "is_new_topic": True,
    }
    orchestrator.conversation.append(starter)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤
    for agent in agents:
        agent.process_message(0, "–í–µ–¥—É—â–∏–π", starter["text"], is_own=False)
    
    print(f"{Fore.MAGENTA}[tick   0] {Style.BRIGHT}üí° –í–µ–¥—É—â–∏–π: {Style.RESET_ALL}{starter['text']}\n")

    try:
        for i in range(MAX_TICKS):
            # –ü–µ—Ä–≤—ã–π —Å–ø–∏–∫–µ—Ä ‚Äî –≤—Å–µ–≥–¥–∞
            entry = orchestrator.run_tick()
            if entry:
                orchestrator.print_entry(entry)
            
            # –í—Ç–æ—Ä–æ–π —Å–ø–∏–∫–µ—Ä ‚Äî —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 50% (–∂–∏–≤–æ–π –¥–∏–∞–ª–æ–≥!)
            if random.random() < 0.50:
                entry2 = orchestrator.run_tick()
                if entry2:
                    orchestrator.print_entry(entry2)

            # –∫–∞–∂–¥—ã–µ 10 —Ç–∏–∫–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            if (i + 1) % 10 == 0:
                orchestrator.print_stats()

            time.sleep(TICK_DELAY)

    except KeyboardInterrupt:
        print(f"\n{Fore.RED}–°–∏–º—É–ª—è—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
    
    finally:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞–º—è—Ç—å –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤
        print(f"\n{Fore.CYAN}üíæ –°–æ—Ö—Ä–∞–Ω—è—é –ø–∞–º—è—Ç—å –∞–≥–µ–Ω—Ç–æ–≤...{Style.RESET_ALL}")
        orchestrator.save_all_memories()
        print(f"{Fore.GREEN}‚úì –ü–∞–º—è—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ {MEMORY_DB_PATH}{Style.RESET_ALL}")

    # –∏—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    print(f"\n{Fore.MAGENTA}{Style.BRIGHT}{'‚ïê' * 60}")
    print(f"{Fore.MAGENTA}{Style.BRIGHT}  –°–∏–º—É–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –í—Å–µ–≥–æ —Ç–∏–∫–æ–≤: {orchestrator.tick}")
    orchestrator.print_stats()

    # —Å—á—ë—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –∞–≥–µ–Ω—Ç–∞–º
    counts = {}
    for e in orchestrator.conversation:
        counts[e["name"]] = counts.get(e["name"], 0) + 1
    print(f"{Fore.WHITE}–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π:")
    for name, cnt in sorted(counts.items()):
        print(f"  {name}: {cnt}")


if __name__ == "__main__":
    main()
